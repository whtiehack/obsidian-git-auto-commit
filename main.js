var _=Object.create;var f=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,Z=Object.prototype.hasOwnProperty;var K=(i,e)=>{for(var t in e)f(i,t,{get:e[t],enumerable:!0})},E=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of q(e))!Z.call(i,s)&&s!==t&&f(i,s,{get:()=>e[s],enumerable:!(n=j(e,s))||n.enumerable});return i};var Q=(i,e,t)=>(t=i!=null?_(J(i)):{},E(e||!i||!i.__esModule?f(t,"default",{value:i,enumerable:!0}):t,i)),X=i=>E(f({},"__esModule",{value:!0}),i);var it={};K(it,{default:()=>P});module.exports=X(it);var d=require("obsidian");var a=require("obsidian");var Y={settingsTitle:"Auto Git Commit",sectionAutomation:"Automation",sectionConfiguration:"Configuration",sectionRepository:"Repository",autoCommitName:"Enable auto commit",autoCommitDesc:"Automatically commit when files change (debounced).",debounceName:"Debounce delay (seconds)",debounceDesc:"Wait time after last change before committing.",autoPushName:"Auto push after commit",autoPushDesc:"Push to remote after successful commit.",autoPullOnOpenName:"Auto pull on open",autoPullOnOpenDesc:"Pull from remote when Obsidian opens.",templateName:"Commit message template",templateDesc:"Variables: {{date}}, {{time}}, {{files}}, {{count}}",gitPathName:"Git binary path",gitPathDesc:"Path to git executable. Default: git",gitPathPlaceholder:"Path to git executable",ignoreObsidianName:"Ignore config directory",ignoreObsidianDesc:"Exclude Obsidian config folder from triggering auto-commits.",includeFileListName:"Include file list in commit body",includeFileListDesc:"List changed files in commit message body, one per line.",showStatusBadgeName:"Show git status in file explorer",showStatusBadgeDesc:"Display colored dots next to changed files and folders.",showRibbonButtonName:"Show ribbon button",showRibbonButtonDesc:"Add a ribbon icon for quick Git actions.",ribbonMenuPull:"Pull",ribbonMenuCommit:"Commit",ribbonMenuPush:"Push",ribbonMenuCommitAndPush:"Commit and push",ribbonMenuRevertAll:"Revert all changes",noticeReverted:"GitAutoCommit: All changes reverted.",noticeRevertFailed:i=>`GitAutoCommit: Revert failed - ${i}`,sectionSetup:"Setup",setupNotRepo:"Not a Git repository",setupEmptyRepo:"Empty repository (no commits)",setupLocalOnly:"Local only (no remote)",setupNoUpstream:"Remote configured (no upstream)",setupReady:"Ready",wizardConnectRemote:"Connect to remote repository",wizardConnectRemoteDesc:"Sync with an existing remote repository.",wizardConnectButton:"Connect",wizardInitAndPush:"Create new repository",wizardInitAndPushDesc:"Initialize and push to an empty remote.",wizardInitAndPushButton:"Create & Push",wizardLocalOnly:"Local version control only",wizardLocalOnlyDesc:"Just track changes locally without remote sync.",wizardLocalOnlyButton:"Initialize",wizardSetUpstream:"Set upstream branch",wizardSetUpstreamDesc:"Push current branch and set upstream tracking.",wizardSetUpstreamButton:"Set Upstream",noticeConnected:"GitAutoCommit: Connected to remote repository.",noticeConnectFailed:i=>`GitAutoCommit: Connect failed - ${i}`,noticeInitPushSuccess:"GitAutoCommit: Repository created and pushed.",noticeInitPushFailed:i=>`GitAutoCommit: Init/push failed - ${i}`,noticeUpstreamSet:"GitAutoCommit: Upstream branch set.",noticeUpstreamFailed:i=>`GitAutoCommit: Set upstream failed - ${i}`,repoStatusName:"Repository status",repoNotInitialized:"Not a git repository",repoInitialized:"Git repository initialized",initRepoButton:"Initialize repository",pullNowName:"Pull from remote",pullNowDesc:"Fetch and merge changes from the remote repository.",pullNowButton:"Pull",commitNowName:"Commit changes",commitNowDesc:"Commit all current changes.",commitNowButton:"Commit",pushNowName:"Push to remote",pushNowDesc:"Push commits to the remote repository.",pushNowButton:"Push",remoteUrlName:"Remote URL (origin)",remoteUrlDesc:"Set the remote repository URL for push.",remoteUrlPlaceholder:"https://github.com/user/repo.git",saveButton:"Save",conflictStatusName:"Merge conflicts detected",conflictStatusDesc:"Please resolve conflicts manually, then click the button below.",resolveConflictButton:"Mark as resolved",noticeNoChanges:"GitAutoCommit: No changes to commit.",noticeCommitted:i=>`GitAutoCommit: Committed ${i} file(s).`,noticePushed:"GitAutoCommit: Pushed to remote.",noticePulled:"GitAutoCommit: Pulled from remote.",noticeAutoGitError:i=>`GitAutoCommit: Error - ${i}`,noticePushFailed:i=>`GitAutoCommit: Push failed - ${i}`,noticePullFailed:i=>`GitAutoCommit: Pull failed - ${i}`,noticeMobileNotSupported:"GitAutoCommit: Git not available on mobile.",noticeDesktopOnly:"GitAutoCommit: Requires desktop vault.",noticeRepoInitialized:"GitAutoCommit: Repository initialized.",noticeRemoteSaved:"GitAutoCommit: Remote URL saved.",noticeConflictDetected:"GitAutoCommit: Merge conflicts detected! Please resolve manually.",noticeConflictResolved:"GitAutoCommit: Conflicts marked as resolved.",noticeCannotCommitConflict:"GitAutoCommit: Cannot commit while conflicts exist."},S={settingsTitle:"\u81EA\u52A8 Git \u63D0\u4EA4",sectionAutomation:"\u81EA\u52A8\u5316",sectionConfiguration:"\u914D\u7F6E",sectionRepository:"\u4ED3\u5E93",autoCommitName:"\u542F\u7528\u81EA\u52A8\u63D0\u4EA4",autoCommitDesc:"\u6587\u4EF6\u53D8\u52A8\u540E\u81EA\u52A8\u63D0\u4EA4\uFF08\u9632\u6296\uFF09\u3002",debounceName:"\u9632\u6296\u5EF6\u8FDF\uFF08\u79D2\uFF09",debounceDesc:"\u6700\u540E\u4E00\u6B21\u53D8\u52A8\u540E\u7B49\u5F85\u591A\u4E45\u518D\u63D0\u4EA4\u3002",autoPushName:"\u63D0\u4EA4\u540E\u81EA\u52A8\u63A8\u9001",autoPushDesc:"\u63D0\u4EA4\u6210\u529F\u540E\u81EA\u52A8\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",autoPullOnOpenName:"\u6253\u5F00\u65F6\u81EA\u52A8\u62C9\u53D6",autoPullOnOpenDesc:"\u6253\u5F00 Obsidian \u65F6\u81EA\u52A8\u4ECE\u8FDC\u7A0B\u4ED3\u5E93\u62C9\u53D6\u3002",templateName:"\u63D0\u4EA4\u6D88\u606F\u6A21\u677F",templateDesc:"\u53D8\u91CF: {{date}}, {{time}}, {{files}}, {{count}}",gitPathName:"Git \u53EF\u6267\u884C\u6587\u4EF6\u8DEF\u5F84",gitPathDesc:"git \u7684\u8DEF\u5F84\uFF0C\u9ED8\u8BA4: git",gitPathPlaceholder:"git \u53EF\u6267\u884C\u6587\u4EF6\u8DEF\u5F84",ignoreObsidianName:"\u5FFD\u7565\u914D\u7F6E\u76EE\u5F55",ignoreObsidianDesc:"\u6392\u9664 Obsidian \u914D\u7F6E\u6587\u4EF6\u5939\u89E6\u53D1\u81EA\u52A8\u63D0\u4EA4\u3002",includeFileListName:"\u5728\u63D0\u4EA4\u6B63\u6587\u4E2D\u5305\u542B\u6587\u4EF6\u5217\u8868",includeFileListDesc:"\u5728\u63D0\u4EA4\u6D88\u606F\u6B63\u6587\u4E2D\u5217\u51FA\u53D8\u52A8\u7684\u6587\u4EF6\uFF0C\u6BCF\u884C\u4E00\u4E2A\u3002",showStatusBadgeName:"\u5728\u6587\u4EF6\u5217\u8868\u663E\u793A Git \u72B6\u6001",showStatusBadgeDesc:"\u5728\u53D8\u52A8\u7684\u6587\u4EF6\u548C\u6587\u4EF6\u5939\u65C1\u663E\u793A\u5F69\u8272\u5706\u70B9\u3002",showRibbonButtonName:"\u663E\u793A\u4FA7\u8FB9\u680F\u6309\u94AE",showRibbonButtonDesc:"\u6DFB\u52A0\u5FEB\u6377 Git \u64CD\u4F5C\u6309\u94AE\u3002",ribbonMenuPull:"\u62C9\u53D6",ribbonMenuCommit:"\u63D0\u4EA4",ribbonMenuPush:"\u63A8\u9001",ribbonMenuCommitAndPush:"\u63D0\u4EA4\u5E76\u63A8\u9001",ribbonMenuRevertAll:"\u8FD8\u539F\u6240\u6709\u4FEE\u6539",noticeReverted:"GitAutoCommit: \u5DF2\u8FD8\u539F\u6240\u6709\u4FEE\u6539\u3002",noticeRevertFailed:i=>`GitAutoCommit: \u8FD8\u539F\u5931\u8D25 - ${i}`,sectionSetup:"\u521D\u59CB\u8BBE\u7F6E",setupNotRepo:"\u5C1A\u672A\u521D\u59CB\u5316\u4E3A Git \u4ED3\u5E93",setupEmptyRepo:"\u7A7A\u4ED3\u5E93\uFF08\u65E0\u63D0\u4EA4\uFF09",setupLocalOnly:"\u4EC5\u672C\u5730\uFF08\u65E0\u8FDC\u7A0B\uFF09",setupNoUpstream:"\u5DF2\u914D\u7F6E\u8FDC\u7A0B\uFF08\u65E0\u4E0A\u6E38\u5206\u652F\uFF09",setupReady:"\u5C31\u7EEA",wizardConnectRemote:"\u8FDE\u63A5\u8FDC\u7A0B\u4ED3\u5E93",wizardConnectRemoteDesc:"\u540C\u6B65\u5230\u5DF2\u6709\u7684\u8FDC\u7A0B\u4ED3\u5E93\u3002",wizardConnectButton:"\u8FDE\u63A5",wizardInitAndPush:"\u521B\u5EFA\u65B0\u4ED3\u5E93",wizardInitAndPushDesc:"\u521D\u59CB\u5316\u5E76\u63A8\u9001\u5230\u7A7A\u7684\u8FDC\u7A0B\u4ED3\u5E93\u3002",wizardInitAndPushButton:"\u521B\u5EFA\u5E76\u63A8\u9001",wizardLocalOnly:"\u4EC5\u672C\u5730\u7248\u672C\u63A7\u5236",wizardLocalOnlyDesc:"\u4EC5\u5728\u672C\u5730\u8DDF\u8E2A\u53D8\u66F4\uFF0C\u4E0D\u540C\u6B65\u8FDC\u7A0B\u3002",wizardLocalOnlyButton:"\u521D\u59CB\u5316",wizardSetUpstream:"\u8BBE\u7F6E\u4E0A\u6E38\u5206\u652F",wizardSetUpstreamDesc:"\u63A8\u9001\u5F53\u524D\u5206\u652F\u5E76\u8BBE\u7F6E\u4E0A\u6E38\u8DDF\u8E2A\u3002",wizardSetUpstreamButton:"\u8BBE\u7F6E\u4E0A\u6E38",noticeConnected:"GitAutoCommit: \u5DF2\u8FDE\u63A5\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",noticeConnectFailed:i=>`GitAutoCommit: \u8FDE\u63A5\u5931\u8D25 - ${i}`,noticeInitPushSuccess:"GitAutoCommit: \u4ED3\u5E93\u5DF2\u521B\u5EFA\u5E76\u63A8\u9001\u3002",noticeInitPushFailed:i=>`GitAutoCommit: \u521D\u59CB\u5316/\u63A8\u9001\u5931\u8D25 - ${i}`,noticeUpstreamSet:"GitAutoCommit: \u5DF2\u8BBE\u7F6E\u4E0A\u6E38\u5206\u652F\u3002",noticeUpstreamFailed:i=>`GitAutoCommit: \u8BBE\u7F6E\u4E0A\u6E38\u5931\u8D25 - ${i}`,repoStatusName:"\u4ED3\u5E93\u72B6\u6001",repoNotInitialized:"\u5C1A\u672A\u521D\u59CB\u5316\u4E3A Git \u4ED3\u5E93",repoInitialized:"Git \u4ED3\u5E93\u5DF2\u521D\u59CB\u5316",initRepoButton:"\u521D\u59CB\u5316\u4ED3\u5E93",pullNowName:"\u4ECE\u8FDC\u7A0B\u62C9\u53D6",pullNowDesc:"\u4ECE\u8FDC\u7A0B\u4ED3\u5E93\u83B7\u53D6\u5E76\u5408\u5E76\u66F4\u6539\u3002",pullNowButton:"\u62C9\u53D6",commitNowName:"\u63D0\u4EA4\u66F4\u6539",commitNowDesc:"\u63D0\u4EA4\u6240\u6709\u5F53\u524D\u66F4\u6539\u3002",commitNowButton:"\u63D0\u4EA4",pushNowName:"\u63A8\u9001\u5230\u8FDC\u7A0B",pushNowDesc:"\u5C06\u63D0\u4EA4\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",pushNowButton:"\u63A8\u9001",remoteUrlName:"\u8FDC\u7A0B\u4ED3\u5E93\u5730\u5740 (origin)",remoteUrlDesc:"\u8BBE\u7F6E\u7528\u4E8E\u63A8\u9001\u7684\u8FDC\u7A0B\u4ED3\u5E93\u5730\u5740\u3002",remoteUrlPlaceholder:"https://github.com/user/repo.git",saveButton:"\u4FDD\u5B58",conflictStatusName:"\u68C0\u6D4B\u5230\u5408\u5E76\u51B2\u7A81",conflictStatusDesc:"\u8BF7\u624B\u52A8\u89E3\u51B3\u51B2\u7A81\u540E\uFF0C\u70B9\u51FB\u4E0B\u65B9\u6309\u94AE\u3002",resolveConflictButton:"\u6807\u8BB0\u4E3A\u5DF2\u89E3\u51B3",noticeNoChanges:"GitAutoCommit: \u6CA1\u6709\u53EF\u63D0\u4EA4\u7684\u66F4\u6539\u3002",noticeCommitted:i=>`GitAutoCommit: \u5DF2\u63D0\u4EA4 ${i} \u4E2A\u6587\u4EF6\u3002`,noticePushed:"GitAutoCommit: \u5DF2\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",noticePulled:"GitAutoCommit: \u5DF2\u4ECE\u8FDC\u7A0B\u4ED3\u5E93\u62C9\u53D6\u3002",noticeAutoGitError:i=>`GitAutoCommit: \u9519\u8BEF - ${i}`,noticePushFailed:i=>`GitAutoCommit: \u63A8\u9001\u5931\u8D25 - ${i}`,noticePullFailed:i=>`GitAutoCommit: \u62C9\u53D6\u5931\u8D25 - ${i}`,noticeMobileNotSupported:"GitAutoCommit: \u79FB\u52A8\u7AEF\u4E0D\u652F\u6301 Git\u3002",noticeDesktopOnly:"GitAutoCommit: \u9700\u8981\u684C\u9762\u7AEF\u3002",noticeRepoInitialized:"GitAutoCommit: \u4ED3\u5E93\u5DF2\u521D\u59CB\u5316\u3002",noticeRemoteSaved:"GitAutoCommit: \u8FDC\u7A0B\u5730\u5740\u5DF2\u4FDD\u5B58\u3002",noticeConflictDetected:"GitAutoCommit: \u68C0\u6D4B\u5230\u5408\u5E76\u51B2\u7A81\uFF01\u8BF7\u624B\u52A8\u89E3\u51B3\u3002",noticeConflictResolved:"GitAutoCommit: \u51B2\u7A81\u5DF2\u6807\u8BB0\u4E3A\u89E3\u51B3\u3002",noticeCannotCommitConflict:"GitAutoCommit: \u5B58\u5728\u51B2\u7A81\u65F6\u65E0\u6CD5\u63D0\u4EA4\u3002"},F={en:Y,zh:S,"zh-CN":S,"zh-TW":S};function tt(){return window.localStorage.getItem("language")||"en"}function g(){let i=tt();return F[i]||F.en}var G=require("child_process"),v=require("fs"),z=Q(require("path"));function m({cwd:i,gitPath:e,args:t}){return new Promise((n,s)=>{(0,G.execFile)(e,t,{cwd:i,windowsHide:!0,env:{...process.env,GIT_TERMINAL_PROMPT:"0"}},(o,c,l)=>{if(o){s(new Error((l==null?void 0:l.trim())||o.message));return}n(c)})})}async function O(i,e){if(!e)return;let t=z.join(i,".gitignore"),n=e.endsWith("/")?e:`${e}/`,s="";try{s=await v.promises.readFile(t,"utf8")}catch(u){if(u.code!=="ENOENT")throw u}if(s.split(/\r?\n/).some(u=>u.trim()===n))return;let c=s.includes(`\r
`)?`\r
`:`
`,l=s.length>0&&!s.endsWith(`
`)?c:"";await v.promises.writeFile(t,`${s}${l}${n}${c}`,"utf8")}async function N(i,e){if(!await b(i,e))return"not-a-repo";try{await m({cwd:i,gitPath:e,args:["rev-parse","HEAD"]})}catch(n){return"empty-repo"}if(!await p(i,e))return"local-only";try{return await m({cwd:i,gitPath:e,args:["rev-parse","--abbrev-ref","@{u}"]}),"ready"}catch(n){return"remote-no-upstream"}}async function U(i,e){let t=await m({cwd:i,gitPath:e,args:["status","--porcelain=v1","-z"]});if(!t)return[];let n=t.split("\0").filter(Boolean),s=[];for(let o=0;o<n.length;o++){let c=n[o],l=c.slice(0,2),u=c.slice(3);if(u&&s.push(u),l.startsWith("R")||l.startsWith("C")){let r=n[++o];r&&s.push(r)}}return[...new Set(s)]}async function M(i,e,t){await m({cwd:i,gitPath:e,args:["add","-A"]});try{await m({cwd:i,gitPath:e,args:["commit","-m",t]})}catch(n){let s=n.message;if(s.includes("nothing to commit")||s.includes("no changes added"))return;throw n}}async function x(i,e){let t=await T(i,e);await m({cwd:i,gitPath:e,args:["push","-u","origin",t]})}async function w(i,e){let t=await N(i,e);if(t!=="ready")return{success:!1,hasConflicts:!1,message:`Repository not ready: ${t}`,notReady:!0};try{try{return{success:!0,hasConflicts:!1,message:await m({cwd:i,gitPath:e,args:["pull"]})}}catch(n){let s=await T(i,e);return{success:!0,hasConflicts:!1,message:await m({cwd:i,gitPath:e,args:["pull","origin",s]})}}}catch(n){let s=n.message;if(s.includes("CONFLICT")||s.includes("Merge conflict"))return{success:!1,hasConflicts:!0,message:s};throw n}}async function R(i,e){try{return(await m({cwd:i,gitPath:e,args:["diff","--name-only","--diff-filter=U"]})).split(`
`).map(n=>n.trim()).filter(Boolean)}catch(t){return[]}}async function L(i,e){return(await R(i,e)).length>0}async function C(i,e){await m({cwd:i,gitPath:e,args:["add","-A"]})}async function b(i,e){try{return await m({cwd:i,gitPath:e,args:["rev-parse","--git-dir"]}),!0}catch(t){return!1}}async function D(i,e){await m({cwd:i,gitPath:e,args:["init"]})}async function p(i,e){try{return(await m({cwd:i,gitPath:e,args:["remote","get-url","origin"]})).trim()}catch(t){return""}}async function A(i,e,t){await p(i,e)?await m({cwd:i,gitPath:e,args:["remote","set-url","origin",t]}):await m({cwd:i,gitPath:e,args:["remote","add","origin",t]})}async function k(i,e){await m({cwd:i,gitPath:e,args:["checkout","--","."]}),await m({cwd:i,gitPath:e,args:["clean","-fd"]})}async function V(i,e){let t=new Map;try{let n=await m({cwd:i,gitPath:e,args:["status","--porcelain=v1","-z"]});if(!n)return t;let s=n.split("\0").filter(Boolean);for(let o=0;o<s.length;o++){let c=s[o],l=c.slice(0,2),u=c.slice(3),r="";l==="??"||l.includes("?")||l.includes("A")?r="A":l.includes("R")?r="R":(l.includes("M")||l.includes("U"))&&(r="M"),u&&r&&t.set(u,r),(l.startsWith("R")||l.startsWith("C"))&&o++}}catch(n){}return t}async function et(i,e){try{let n=(await m({cwd:i,gitPath:e,args:["remote","show","origin"]})).match(/HEAD branch:\s*(\S+)/);if(n&&n[1]!=="(unknown)")return n[1]}catch(t){}try{let t=await m({cwd:i,gitPath:e,args:["ls-remote","--heads","origin"]});if(!t.trim())return null;if(t.includes("refs/heads/main"))return"main";if(t.includes("refs/heads/master"))return"master";let n=t.match(/refs\/heads\/(\S+)/);if(n)return n[1]}catch(t){}return null}async function $(i,e,t,n="main",s){await m({cwd:i,gitPath:e,args:["init","-b",n]}),await O(i,s),await m({cwd:i,gitPath:e,args:["add","-A"]}),await m({cwd:i,gitPath:e,args:["commit","-m","Initial commit"]}),await m({cwd:i,gitPath:e,args:["remote","add","origin",t]}),await m({cwd:i,gitPath:e,args:["push","-u","origin",n]})}async function H(i,e,t,n){await b(i,e)||await m({cwd:i,gitPath:e,args:["init","-b","main"]});let s=await p(i,e);s?s!==t&&await m({cwd:i,gitPath:e,args:["remote","set-url","origin",t]}):await m({cwd:i,gitPath:e,args:["remote","add","origin",t]}),await m({cwd:i,gitPath:e,args:["fetch","origin"]});let o=await et(i,e);if(!o){await O(i,n),await m({cwd:i,gitPath:e,args:["add","-A"]});try{await m({cwd:i,gitPath:e,args:["commit","-m","Initial commit"]})}catch(l){if(!l.message.includes("nothing to commit"))throw l}return await m({cwd:i,gitPath:e,args:["push","-u","origin","main"]}),{branch:"main"}}let c=!1;try{await m({cwd:i,gitPath:e,args:["rev-parse","HEAD"]}),c=!0}catch(l){c=!1}if(!c)await m({cwd:i,gitPath:e,args:["checkout","-b",o,`origin/${o}`]});else{try{await m({cwd:i,gitPath:e,args:["branch","-M",o]})}catch(l){}await m({cwd:i,gitPath:e,args:["branch",`--set-upstream-to=origin/${o}`,o]})}return{branch:o}}async function B(i,e){let t=await T(i,e);await m({cwd:i,gitPath:e,args:["push","-u","origin",t]})}async function T(i,e){return(await m({cwd:i,gitPath:e,args:["rev-parse","--abbrev-ref","HEAD"]})).trim()}var I={autoCommit:!1,debounceSeconds:30,commitTemplate:"vault backup: {{date}} {{time}}",includeFileList:!0,autoPush:!1,autoPullOnOpen:!1,gitPath:"git",ignoreObsidianDir:!0,showStatusBadge:!0,showRibbonButton:!0},y=class extends a.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this,t=g();if(e.empty(),new a.Setting(e).setName(t.settingsTitle).setHeading(),!a.Platform.isMobileApp){let s=e.createDiv();this.displaySetupSection(s)}if(!a.Platform.isMobileApp){new a.Setting(e).setName(t.sectionRepository).setHeading();let s=e.createDiv();this.displayRepoSection(s)}new a.Setting(e).setName(t.sectionAutomation).setHeading(),new a.Setting(e).setName(t.autoPullOnOpenName).setDesc(t.autoPullOnOpenDesc).addToggle(s=>s.setValue(this.plugin.settings.autoPullOnOpen).onChange(async o=>{this.plugin.settings.autoPullOnOpen=o,await this.plugin.saveSettings()}));let n;new a.Setting(e).setName(t.autoCommitName).setDesc(t.autoCommitDesc).addToggle(s=>s.setValue(this.plugin.settings.autoCommit).onChange(async o=>{this.plugin.settings.autoCommit=o,await this.plugin.saveSettings(),this.plugin.resetVaultListeners(),n.style.display=o?"block":"none"})),n=e.createDiv(),n.style.display=this.plugin.settings.autoCommit?"block":"none",new a.Setting(n).setName(t.debounceName).setDesc(t.debounceDesc).addText(s=>s.setPlaceholder("30").setValue(String(this.plugin.settings.debounceSeconds)).onChange(async o=>{let c=parseInt(o);!isNaN(c)&&c>=5&&(this.plugin.settings.debounceSeconds=c,await this.plugin.saveSettings())})),new a.Setting(n).setName(t.autoPushName).setDesc(t.autoPushDesc).addToggle(s=>s.setValue(this.plugin.settings.autoPush).onChange(async o=>{this.plugin.settings.autoPush=o,await this.plugin.saveSettings()})),new a.Setting(e).setName(t.sectionConfiguration).setHeading(),new a.Setting(e).setName(t.templateName).setDesc(t.templateDesc).addTextArea(s=>s.setPlaceholder("vault backup: {{date}} {{time}}").setValue(this.plugin.settings.commitTemplate).onChange(async o=>{this.plugin.settings.commitTemplate=o,await this.plugin.saveSettings()})),new a.Setting(e).setName(t.includeFileListName).setDesc(t.includeFileListDesc).addToggle(s=>s.setValue(this.plugin.settings.includeFileList).onChange(async o=>{this.plugin.settings.includeFileList=o,await this.plugin.saveSettings()})),new a.Setting(e).setName(t.showStatusBadgeName).setDesc(t.showStatusBadgeDesc).addToggle(s=>s.setValue(this.plugin.settings.showStatusBadge).onChange(async o=>{this.plugin.settings.showStatusBadge=o,await this.plugin.saveSettings(),this.plugin.refreshStatusBadges()})),new a.Setting(e).setName(t.showRibbonButtonName).setDesc(t.showRibbonButtonDesc).addToggle(s=>s.setValue(this.plugin.settings.showRibbonButton).onChange(async o=>{this.plugin.settings.showRibbonButton=o,await this.plugin.saveSettings(),this.plugin.updateRibbonButton()})),new a.Setting(e).setName(t.gitPathName).setDesc(t.gitPathDesc).addText(s=>s.setPlaceholder(t.gitPathPlaceholder).setValue(this.plugin.settings.gitPath).onChange(async o=>{this.plugin.settings.gitPath=o.trim()||"git",await this.plugin.saveSettings()})),new a.Setting(e).setName(t.ignoreObsidianName).setDesc(t.ignoreObsidianDesc).addToggle(s=>s.setValue(this.plugin.settings.ignoreObsidianDir).onChange(async o=>{this.plugin.settings.ignoreObsidianDir=o,await this.plugin.saveSettings()}))}async displaySetupSection(e){let t=g(),n=this.plugin.getVaultPathSafe();if(!n){e.empty();return}let s=this.plugin.settings.gitPath,o=await N(n,s);if(e.empty(),o==="ready")return;new a.Setting(e).setName(t.sectionSetup).setHeading();let c={"not-a-repo":t.setupNotRepo,"empty-repo":t.setupEmptyRepo,"local-only":t.setupLocalOnly,"remote-no-upstream":t.setupNoUpstream,ready:t.setupReady};new a.Setting(e).setName(t.repoStatusName).setDesc(c[o]);let l="";o==="not-a-repo"||o==="empty-repo"?(new a.Setting(e).setName(t.wizardConnectRemote).setDesc(t.wizardConnectRemoteDesc).addText(u=>u.setPlaceholder(t.remoteUrlPlaceholder).onChange(r=>{l=r.trim()})).addButton(u=>u.setButtonText(t.wizardConnectButton).onClick(async()=>{if(l)try{let r=this.plugin.settings.ignoreObsidianDir?this.app.vault.configDir:void 0;await H(n,s,l,r),new a.Notice(t.noticeConnected),this.display(),this.plugin.refreshStatusBadges()}catch(r){new a.Notice(t.noticeConnectFailed(r.message))}})),new a.Setting(e).setName(t.wizardInitAndPush).setDesc(t.wizardInitAndPushDesc).addText(u=>u.setPlaceholder(t.remoteUrlPlaceholder).onChange(r=>{l=r.trim()})).addButton(u=>u.setButtonText(t.wizardInitAndPushButton).onClick(async()=>{if(l)try{let r=this.plugin.settings.ignoreObsidianDir?this.app.vault.configDir:void 0;await $(n,s,l,"main",r),new a.Notice(t.noticeInitPushSuccess),this.display(),this.plugin.refreshStatusBadges()}catch(r){new a.Notice(t.noticeInitPushFailed(r.message))}})),new a.Setting(e).setName(t.wizardLocalOnly).setDesc(t.wizardLocalOnlyDesc).addButton(u=>u.setButtonText(t.wizardLocalOnlyButton).onClick(async()=>{try{await D(n,s),new a.Notice(t.noticeRepoInitialized),this.display()}catch(r){new a.Notice(r.message)}}))):o==="local-only"?new a.Setting(e).setName(t.wizardInitAndPush).setDesc(t.wizardInitAndPushDesc).addText(u=>u.setPlaceholder(t.remoteUrlPlaceholder).onChange(r=>{l=r.trim()})).addButton(u=>u.setButtonText(t.wizardSetUpstreamButton).onClick(async()=>{if(l)try{await A(n,s,l),await B(n,s),new a.Notice(t.noticeUpstreamSet),this.display()}catch(r){new a.Notice(t.noticeUpstreamFailed(r.message))}})):o==="remote-no-upstream"&&new a.Setting(e).setName(t.wizardSetUpstream).setDesc(t.wizardSetUpstreamDesc).addButton(u=>u.setButtonText(t.wizardSetUpstreamButton).onClick(async()=>{try{await B(n,s),new a.Notice(t.noticeUpstreamSet),this.display()}catch(r){new a.Notice(t.noticeUpstreamFailed(r.message))}}))}async displayRepoSection(e){let t=g(),n=this.plugin.getVaultPathSafe();if(!n){e.empty();return}let s=this.plugin.settings.gitPath,[o,c,l]=await Promise.all([b(n,s),p(n,s),L(n,s)]);if(e.empty(),!o)new a.Setting(e).setName(t.repoStatusName).setDesc(t.repoNotInitialized).addButton(u=>u.setButtonText(t.initRepoButton).onClick(async()=>{try{await D(n,s),new a.Notice(t.noticeRepoInitialized),this.display()}catch(r){new a.Notice(r.message)}}));else{new a.Setting(e).setName(t.repoStatusName).setDesc(t.repoInitialized),new a.Setting(e).setName(t.pullNowName).setDesc(t.pullNowDesc).addButton(r=>r.setButtonText(t.pullNowButton).onClick(async()=>{try{(await w(n,s)).hasConflicts?(this.plugin.setHasConflicts(!0),new a.Notice(t.noticeConflictDetected),this.display()):(new a.Notice(t.noticePulled),this.plugin.refreshStatusBadges())}catch(h){new a.Notice(t.noticePullFailed(h.message))}})),new a.Setting(e).setName(t.commitNowName).setDesc(t.commitNowDesc).addButton(r=>r.setButtonText(t.commitNowButton).onClick(async()=>{await this.plugin.runCommit("manual")})),new a.Setting(e).setName(t.pushNowName).setDesc(t.pushNowDesc).addButton(r=>r.setButtonText(t.pushNowButton).onClick(async()=>{await this.plugin.doPush()}));let u=c;new a.Setting(e).setName(t.remoteUrlName).setDesc(t.remoteUrlDesc).addText(r=>r.setPlaceholder(t.remoteUrlPlaceholder).setValue(c).onChange(h=>{u=h.trim()})).addButton(r=>r.setButtonText(t.saveButton).onClick(async()=>{if(u)try{await A(n,s,u),new a.Notice(t.noticeRemoteSaved)}catch(h){new a.Notice(h.message)}})),l&&new a.Setting(e).setName(t.conflictStatusName).setDesc(t.conflictStatusDesc).addButton(r=>r.setButtonText(t.resolveConflictButton).setWarning().onClick(async()=>{try{await C(n,s),this.plugin.setHasConflicts(!1),new a.Notice(t.noticeConflictResolved),this.display()}catch(h){new a.Notice(h.message)}}))}}};function W(i,e){return i.replace(/\{\{\s*([a-zA-Z0-9_]+)\s*\}\}/g,(t,n)=>{var s;return(s=e[n])!=null?s:""})}var P=class extends d.Plugin{constructor(){super(...arguments);this.settings=I;this.debounceTimer=null;this.isCommitting=!1;this.pendingRerun=!1;this.vaultEventRefs=[];this.statusRefreshInterval=null;this.currentStatuses=new Map;this.conflictFiles=new Set;this._hasConflicts=!1;this.resolveConflictCommand=null;this.ribbonIconEl=null}async onload(){await this.loadSettings(),this.addSettingTab(new y(this.app,this)),this.updateRibbonButton(),this.addCommand({id:"commit-now",name:"Commit now",callback:()=>this.runCommit("manual")}),this.addCommand({id:"commit-and-push",name:"Commit and push",callback:async()=>{await this.runCommit("manual")&&await this.doPush()}}),this.addCommand({id:"pull-now",name:"Pull now",callback:()=>this.doPull()}),this.addCommand({id:"push-now",name:"Push now",callback:()=>this.doPush()}),this.setupVaultListeners(),this.setupStatusBadges(),this.settings.autoPullOnOpen&&!d.Platform.isMobileApp&&window.setTimeout(()=>{this.doPull()},1e3),this.checkConflicts()}onunload(){this.clearDebounce(),this.removeVaultListeners(),this.clearStatusBadges(),this.statusRefreshInterval&&window.clearInterval(this.statusRefreshInterval),this.ribbonIconEl&&(this.ribbonIconEl.remove(),this.ribbonIconEl=null)}async loadSettings(){this.settings=Object.assign({},I,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}resetVaultListeners(){this.clearDebounce(),this.removeVaultListeners(),this.setupVaultListeners()}removeVaultListeners(){this.vaultEventRefs.forEach(t=>this.app.vault.offref(t)),this.vaultEventRefs=[]}setupVaultListeners(){if(!this.settings.autoCommit)return;if(d.Platform.isMobileApp){new d.Notice(g().noticeMobileNotSupported);return}let t=n=>this.onFileChange(n);this.vaultEventRefs.push(this.app.vault.on("create",t)),this.vaultEventRefs.push(this.app.vault.on("modify",t)),this.vaultEventRefs.push(this.app.vault.on("delete",t)),this.vaultEventRefs.push(this.app.vault.on("rename",t))}onFileChange(t){t instanceof d.TFile&&(this.shouldIgnore(t.path)||(this.scheduleCommit(),this.scheduleStatusRefresh()))}shouldIgnore(t){if(t.startsWith(".git/")||t.startsWith(".git\\"))return!0;if(this.settings.ignoreObsidianDir){let n=this.app.vault.configDir;if(t.startsWith(n+"/")||t.startsWith(n+"\\"))return!0}return!1}scheduleCommit(){this.clearDebounce(),this.debounceTimer=window.setTimeout(()=>{this.debounceTimer=null,this.runCommit("auto")},this.settings.debounceSeconds*1e3)}clearDebounce(){this.debounceTimer!==null&&(window.clearTimeout(this.debounceTimer),this.debounceTimer=null)}getVaultPath(){let t=this.app.vault.adapter;if(!(t instanceof d.FileSystemAdapter))throw new Error(g().noticeDesktopOnly);return t.getBasePath()}getVaultPathSafe(){let t=this.app.vault.adapter;return t instanceof d.FileSystemAdapter?t.getBasePath():null}async runCommit(t){if(this._hasConflicts)return t==="manual"&&new d.Notice(g().noticeCannotCommitConflict),!1;if(this.isCommitting)return this.pendingRerun=!0,!1;this.isCommitting=!0,this.pendingRerun=!1;let n=!1;try{let s=this.getVaultPath(),o=this.settings.gitPath,c=await U(s,o);if(c.length===0)return t==="manual"&&new d.Notice(g().noticeNoChanges),!1;let l=new Date,u=W(this.settings.commitTemplate,{date:l.toISOString().slice(0,10),time:l.toTimeString().slice(0,8),files:c.slice(0,5).join(", ")+(c.length>5?"...":""),count:String(c.length)}),r=u;this.settings.includeFileList&&(r=u+`

`+c.join(`
`)),await M(s,o,r),n=!0,new d.Notice(g().noticeCommitted(c.length)),this.settings.autoPush&&await this.doPush(),this.refreshStatusBadges()}catch(s){new d.Notice(g().noticeAutoGitError(s.message))}finally{this.isCommitting=!1,this.pendingRerun&&this.scheduleCommit()}return n}async doPush(){try{let t=this.getVaultPath();await x(t,this.settings.gitPath),new d.Notice(g().noticePushed)}catch(t){new d.Notice(g().noticePushFailed(t.message))}}updateRibbonButton(){this.settings.showRibbonButton&&!d.Platform.isMobileApp?this.ribbonIconEl||(this.ribbonIconEl=this.addRibbonIcon("git-branch","Git",t=>{this.showRibbonMenu(t)})):this.ribbonIconEl&&(this.ribbonIconEl.remove(),this.ribbonIconEl=null)}showRibbonMenu(t){let n=g(),s=new d.Menu;s.addItem(o=>o.setTitle(n.ribbonMenuPull).setIcon("download").onClick(()=>void this.doPull())),s.addItem(o=>o.setTitle(n.ribbonMenuCommit).setIcon("check").onClick(()=>void this.runCommit("manual"))),s.addItem(o=>o.setTitle(n.ribbonMenuPush).setIcon("upload").onClick(()=>void this.doPush())),s.addItem(o=>o.setTitle(n.ribbonMenuCommitAndPush).setIcon("upload").onClick(async()=>{await this.runCommit("manual")&&await this.doPush()})),s.addSeparator(),s.addItem(o=>o.setTitle(n.ribbonMenuRevertAll).setIcon("rotate-ccw").onClick(()=>void this.doRevert())),s.showAtMouseEvent(t)}async doRevert(){try{let t=this.getVaultPath();await k(t,this.settings.gitPath),new d.Notice(g().noticeReverted),this.refreshStatusBadges()}catch(t){new d.Notice(g().noticeRevertFailed(t.message))}}async doPull(){if(d.Platform.isMobileApp){new d.Notice(g().noticeMobileNotSupported);return}try{let t=this.getVaultPath(),n=await w(t,this.settings.gitPath);n.hasConflicts?(await this.checkConflicts(),new d.Notice(g().noticeConflictDetected)):n.success&&(new d.Notice(g().noticePulled),this.refreshStatusBadges())}catch(t){new d.Notice(g().noticePullFailed(t.message))}}async checkConflicts(){let t=this.getVaultPathSafe();if(!t)return;let n=await R(t,this.settings.gitPath);this.conflictFiles=new Set(n),this.setHasConflicts(n.length>0),this.refreshStatusBadges()}setHasConflicts(t){this._hasConflicts=t,t&&!this.resolveConflictCommand?this.resolveConflictCommand=this.addCommand({id:"resolve-conflicts",name:"Mark conflicts as resolved",callback:async()=>{let n=this.getVaultPathSafe();if(n)try{await C(n,this.settings.gitPath),this.conflictFiles.clear(),this.setHasConflicts(!1),new d.Notice(g().noticeConflictResolved),this.refreshStatusBadges()}catch(s){new d.Notice(s.message)}}}):!t&&this.resolveConflictCommand&&(this.resolveConflictCommand=null),t||this.conflictFiles.clear()}setupStatusBadges(){d.Platform.isMobileApp||!this.settings.showStatusBadge||(this.refreshStatusBadges(),this.statusRefreshInterval=window.setInterval(()=>{this.refreshStatusBadges()},5e3))}scheduleStatusRefresh(){this.settings.showStatusBadge&&window.setTimeout(()=>this.refreshStatusBadges(),500)}refreshStatusBadges(){if(!this.settings.showStatusBadge){this.clearStatusBadges();return}let t=this.getVaultPathSafe();t&&V(t,this.settings.gitPath).then(n=>{this.currentStatuses=n,this.updateBadgesInDOM()}).catch(()=>{})}clearStatusBadges(){document.querySelectorAll(".git-status-badge").forEach(t=>t.remove()),this.currentStatuses.clear()}updateBadgesInDOM(){document.querySelectorAll(".git-status-badge").forEach(s=>s.remove());let t=new Map(this.currentStatuses);this.conflictFiles.forEach(s=>{t.set(s,"U")});let n=this.calculateFolderStatuses(t);document.querySelectorAll(".nav-file-title").forEach(s=>{let o=s.getAttribute("data-path");if(!o)return;let c=t.get(o);c&&this.addBadgeToElement(s,c)}),document.querySelectorAll(".nav-folder-title").forEach(s=>{let o=s.getAttribute("data-path");if(!o)return;let c=n.get(o);c&&this.addBadgeToElement(s,c)})}calculateFolderStatuses(t){let n=t||this.currentStatuses,s=new Map;return n.forEach((o,c)=>{let l=c.split(/[/\\]/);for(let u=1;u<l.length;u++){let r=l.slice(0,u).join("/"),h=s.get(r);(!h||this.statusPriority(o)>this.statusPriority(h))&&s.set(r,o)}}),s}statusPriority(t){switch(t){case"U":return 4;case"A":return 3;case"M":return 2;case"R":return 1;default:return 0}}addBadgeToElement(t,n){let s=document.createElement("span");s.className="git-status-badge",s.textContent="\u25CF",n==="U"?s.classList.add("conflict"):n==="M"?s.classList.add("modified"):n==="A"?s.classList.add("added"):n==="R"&&s.classList.add("renamed"),t.appendChild(s)}};
