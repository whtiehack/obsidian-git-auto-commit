var f=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var I=(n,e)=>{for(var t in e)f(n,t,{get:e[t],enumerable:!0})},x=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of F(e))!E.call(n,s)&&s!==t&&f(n,s,{get:()=>e[s],enumerable:!(i=B(e,s))||i.enumerable});return n};var L=n=>x(f({},"__esModule",{value:!0}),n);var V={};I(V,{default:()=>p});module.exports=L(V);var c=require("obsidian");var u=require("obsidian");var O={settingsTitle:"Auto Git Commit",sectionAutomation:"Automation",sectionConfiguration:"Configuration",sectionRepository:"Repository",autoCommitName:"Enable auto commit",autoCommitDesc:"Automatically commit when files change (debounced).",debounceName:"Debounce delay (seconds)",debounceDesc:"Wait time after last change before committing.",autoPushName:"Auto push after commit",autoPushDesc:"Push to remote after successful commit.",templateName:"Commit message template",templateDesc:"Variables: {{date}}, {{time}}, {{files}}, {{count}}",gitPathName:"Git binary path",gitPathDesc:"Path to git executable. Default: git",ignoreObsidianName:"Ignore .obsidian directory",ignoreObsidianDesc:"Exclude config folder from triggering auto-commits.",includeFileListName:"Include file list in commit body",includeFileListDesc:"List changed files in commit message body, one per line.",showStatusBadgeName:"Show git status in file explorer",showStatusBadgeDesc:"Display M (modified) / A (new) badges next to files.",repoStatusName:"Repository status",repoNotInitialized:"Not a git repository",repoInitialized:"Git repository initialized",initRepoButton:"Initialize repository",remoteUrlName:"Remote URL (origin)",remoteUrlDesc:"Set the remote repository URL for push.",remoteUrlPlaceholder:"https://github.com/user/repo.git",saveButton:"Save",noticeNoChanges:"GitAutoCommit: No changes to commit.",noticeCommitted:n=>`GitAutoCommit: Committed ${n} file(s).`,noticePushed:"GitAutoCommit: Pushed to remote.",noticeAutoGitError:n=>`GitAutoCommit: Error - ${n}`,noticePushFailed:n=>`GitAutoCommit: Push failed - ${n}`,noticeMobileNotSupported:"GitAutoCommit: Git not available on mobile.",noticeDesktopOnly:"GitAutoCommit: Requires desktop vault.",noticeRepoInitialized:"GitAutoCommit: Repository initialized.",noticeRemoteSaved:"GitAutoCommit: Remote URL saved."},w={settingsTitle:"\u81EA\u52A8 Git \u63D0\u4EA4",sectionAutomation:"\u81EA\u52A8\u5316",sectionConfiguration:"\u914D\u7F6E",sectionRepository:"\u4ED3\u5E93",autoCommitName:"\u542F\u7528\u81EA\u52A8\u63D0\u4EA4",autoCommitDesc:"\u6587\u4EF6\u53D8\u52A8\u540E\u81EA\u52A8\u63D0\u4EA4\uFF08\u9632\u6296\uFF09\u3002",debounceName:"\u9632\u6296\u5EF6\u8FDF\uFF08\u79D2\uFF09",debounceDesc:"\u6700\u540E\u4E00\u6B21\u53D8\u52A8\u540E\u7B49\u5F85\u591A\u4E45\u518D\u63D0\u4EA4\u3002",autoPushName:"\u63D0\u4EA4\u540E\u81EA\u52A8\u63A8\u9001",autoPushDesc:"\u63D0\u4EA4\u6210\u529F\u540E\u81EA\u52A8\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",templateName:"\u63D0\u4EA4\u6D88\u606F\u6A21\u677F",templateDesc:"\u53D8\u91CF: {{date}}, {{time}}, {{files}}, {{count}}",gitPathName:"Git \u53EF\u6267\u884C\u6587\u4EF6\u8DEF\u5F84",gitPathDesc:"git \u7684\u8DEF\u5F84\uFF0C\u9ED8\u8BA4: git",ignoreObsidianName:"\u5FFD\u7565 .obsidian \u76EE\u5F55",ignoreObsidianDesc:"\u6392\u9664\u914D\u7F6E\u6587\u4EF6\u5939\u89E6\u53D1\u81EA\u52A8\u63D0\u4EA4\u3002",includeFileListName:"\u5728\u63D0\u4EA4\u6B63\u6587\u4E2D\u5305\u542B\u6587\u4EF6\u5217\u8868",includeFileListDesc:"\u5728\u63D0\u4EA4\u6D88\u606F\u6B63\u6587\u4E2D\u5217\u51FA\u53D8\u52A8\u7684\u6587\u4EF6\uFF0C\u6BCF\u884C\u4E00\u4E2A\u3002",showStatusBadgeName:"\u5728\u6587\u4EF6\u5217\u8868\u663E\u793A Git \u72B6\u6001",showStatusBadgeDesc:"\u5728\u6587\u4EF6\u65C1\u663E\u793A M\uFF08\u5DF2\u4FEE\u6539\uFF09/ A\uFF08\u65B0\u6587\u4EF6\uFF09\u6807\u8BB0\u3002",repoStatusName:"\u4ED3\u5E93\u72B6\u6001",repoNotInitialized:"\u5C1A\u672A\u521D\u59CB\u5316\u4E3A Git \u4ED3\u5E93",repoInitialized:"Git \u4ED3\u5E93\u5DF2\u521D\u59CB\u5316",initRepoButton:"\u521D\u59CB\u5316\u4ED3\u5E93",remoteUrlName:"\u8FDC\u7A0B\u4ED3\u5E93\u5730\u5740 (origin)",remoteUrlDesc:"\u8BBE\u7F6E\u7528\u4E8E\u63A8\u9001\u7684\u8FDC\u7A0B\u4ED3\u5E93\u5730\u5740\u3002",remoteUrlPlaceholder:"https://github.com/user/repo.git",saveButton:"\u4FDD\u5B58",noticeNoChanges:"GitAutoCommit: \u6CA1\u6709\u53EF\u63D0\u4EA4\u7684\u66F4\u6539\u3002",noticeCommitted:n=>`GitAutoCommit: \u5DF2\u63D0\u4EA4 ${n} \u4E2A\u6587\u4EF6\u3002`,noticePushed:"GitAutoCommit: \u5DF2\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",noticeAutoGitError:n=>`GitAutoCommit: \u9519\u8BEF - ${n}`,noticePushFailed:n=>`GitAutoCommit: \u63A8\u9001\u5931\u8D25 - ${n}`,noticeMobileNotSupported:"GitAutoCommit: \u79FB\u52A8\u7AEF\u4E0D\u652F\u6301 Git\u3002",noticeDesktopOnly:"GitAutoCommit: \u9700\u8981\u684C\u9762\u7AEF\u3002",noticeRepoInitialized:"GitAutoCommit: \u4ED3\u5E93\u5DF2\u521D\u59CB\u5316\u3002",noticeRemoteSaved:"GitAutoCommit: \u8FDC\u7A0B\u5730\u5740\u5DF2\u4FDD\u5B58\u3002"},v={en:O,zh:w,"zh-CN":w,"zh-TW":w};function U(){return window.localStorage.getItem("language")||"en"}function m(){let n=U();return v[n]||v.en}var C=require("child_process");function h({cwd:n,gitPath:e,args:t}){return new Promise((i,s)=>{(0,C.execFile)(e,t,{cwd:n,windowsHide:!0,env:{...process.env,GIT_TERMINAL_PROMPT:"0"}},(a,o,r)=>{if(a){s(new Error((r==null?void 0:r.trim())||a.message));return}i(o)})})}async function P(n,e){let t=await h({cwd:n,gitPath:e,args:["status","--porcelain=v1","-z"]});if(!t)return[];let i=t.split("\0").filter(Boolean),s=[];for(let a=0;a<i.length;a++){let o=i[a],r=o.slice(0,2),g=o.slice(3);if(g&&s.push(g),r.startsWith("R")||r.startsWith("C")){let l=i[++a];l&&s.push(l)}}return[...new Set(s)]}async function N(n,e,t){await h({cwd:n,gitPath:e,args:["add","-A"]});try{await h({cwd:n,gitPath:e,args:["commit","-m",t]})}catch(i){let s=i.message;if(s.includes("nothing to commit")||s.includes("no changes added"))return;throw i}}async function D(n,e){await h({cwd:n,gitPath:e,args:["push"]})}async function y(n,e){try{return await h({cwd:n,gitPath:e,args:["rev-parse","--git-dir"]}),!0}catch(t){return!1}}async function R(n,e){await h({cwd:n,gitPath:e,args:["init"]})}async function S(n,e){try{return(await h({cwd:n,gitPath:e,args:["remote","get-url","origin"]})).trim()}catch(t){return""}}async function A(n,e,t){await S(n,e)?await h({cwd:n,gitPath:e,args:["remote","set-url","origin",t]}):await h({cwd:n,gitPath:e,args:["remote","add","origin",t]})}async function T(n,e){let t=new Map;try{let i=await h({cwd:n,gitPath:e,args:["status","--porcelain=v1","-z"]});if(!i)return t;let s=i.split("\0").filter(Boolean);for(let a=0;a<s.length;a++){let o=s[a],r=o.slice(0,2),g=o.slice(3),l="";r==="??"||r.includes("?")||r.includes("A")?l="A":r.includes("D")?l="D":r.includes("R")?l="R":(r.includes("M")||r.includes("U"))&&(l="M"),g&&l&&t.set(g,l),(r.startsWith("R")||r.startsWith("C"))&&a++}}catch(i){}return t}var b={autoCommit:!1,debounceSeconds:30,commitTemplate:"vault backup: {{date}} {{time}}",includeFileList:!0,autoPush:!1,gitPath:"git",ignoreObsidianDir:!0,showStatusBadge:!0},d=class extends u.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this,t=m();e.empty(),e.createEl("h2",{text:t.settingsTitle}),u.Platform.isMobileApp||(e.createEl("h3",{text:t.sectionRepository}),this.displayRepoSection(e)),e.createEl("h3",{text:t.sectionAutomation}),new u.Setting(e).setName(t.autoCommitName).setDesc(t.autoCommitDesc).addToggle(i=>i.setValue(this.plugin.settings.autoCommit).onChange(async s=>{this.plugin.settings.autoCommit=s,await this.plugin.saveSettings(),this.plugin.resetVaultListeners(),this.display()})),this.plugin.settings.autoCommit&&(new u.Setting(e).setName(t.debounceName).setDesc(t.debounceDesc).addText(i=>i.setPlaceholder("30").setValue(String(this.plugin.settings.debounceSeconds)).onChange(async s=>{let a=parseInt(s);!isNaN(a)&&a>=5&&(this.plugin.settings.debounceSeconds=a,await this.plugin.saveSettings())})),new u.Setting(e).setName(t.autoPushName).setDesc(t.autoPushDesc).addToggle(i=>i.setValue(this.plugin.settings.autoPush).onChange(async s=>{this.plugin.settings.autoPush=s,await this.plugin.saveSettings()}))),e.createEl("h3",{text:t.sectionConfiguration}),new u.Setting(e).setName(t.templateName).setDesc(t.templateDesc).addTextArea(i=>i.setPlaceholder("vault backup: {{date}} {{time}}").setValue(this.plugin.settings.commitTemplate).onChange(async s=>{this.plugin.settings.commitTemplate=s,await this.plugin.saveSettings()})),new u.Setting(e).setName(t.includeFileListName).setDesc(t.includeFileListDesc).addToggle(i=>i.setValue(this.plugin.settings.includeFileList).onChange(async s=>{this.plugin.settings.includeFileList=s,await this.plugin.saveSettings()})),new u.Setting(e).setName(t.showStatusBadgeName).setDesc(t.showStatusBadgeDesc).addToggle(i=>i.setValue(this.plugin.settings.showStatusBadge).onChange(async s=>{this.plugin.settings.showStatusBadge=s,await this.plugin.saveSettings(),this.plugin.refreshStatusBadges()})),new u.Setting(e).setName(t.gitPathName).setDesc(t.gitPathDesc).addText(i=>i.setPlaceholder("git").setValue(this.plugin.settings.gitPath).onChange(async s=>{this.plugin.settings.gitPath=s.trim()||"git",await this.plugin.saveSettings()})),new u.Setting(e).setName(t.ignoreObsidianName).setDesc(t.ignoreObsidianDesc).addToggle(i=>i.setValue(this.plugin.settings.ignoreObsidianDir).onChange(async s=>{this.plugin.settings.ignoreObsidianDir=s,await this.plugin.saveSettings()}))}async displayRepoSection(e){let t=m(),i=this.plugin.getVaultPathSafe();if(!i)return;let s=this.plugin.settings.gitPath;if(!await y(i,s))new u.Setting(e).setName(t.repoStatusName).setDesc(t.repoNotInitialized).addButton(o=>o.setButtonText(t.initRepoButton).onClick(async()=>{try{await R(i,s),new u.Notice(t.noticeRepoInitialized),this.display()}catch(r){new u.Notice(r.message)}}));else{new u.Setting(e).setName(t.repoStatusName).setDesc(t.repoInitialized);let o=await S(i,s),r=o;new u.Setting(e).setName(t.remoteUrlName).setDesc(t.remoteUrlDesc).addText(g=>g.setPlaceholder(t.remoteUrlPlaceholder).setValue(o).onChange(l=>{r=l.trim()})).addButton(g=>g.setButtonText(t.saveButton).onClick(async()=>{if(r)try{await A(i,s,r),new u.Notice(t.noticeRemoteSaved)}catch(l){new u.Notice(l.message)}}))}}};function G(n,e){return n.replace(/\{\{\s*([a-zA-Z0-9_]+)\s*\}\}/g,(t,i)=>{var s;return(s=e[i])!=null?s:""})}var p=class extends c.Plugin{constructor(){super(...arguments);this.settings=b;this.debounceTimer=null;this.isCommitting=!1;this.pendingRerun=!1;this.vaultEventRefs=[];this.statusRefreshInterval=null;this.currentStatuses=new Map}async onload(){await this.loadSettings(),this.addSettingTab(new d(this.app,this)),this.addCommand({id:"commit-now",name:"Commit now",callback:()=>this.runCommit("manual")}),this.addCommand({id:"commit-and-push",name:"Commit and push",callback:async()=>{await this.runCommit("manual")&&await this.doPush()}}),this.setupVaultListeners(),this.setupStatusBadges()}onunload(){this.clearDebounce(),this.removeVaultListeners(),this.clearStatusBadges(),this.statusRefreshInterval&&window.clearInterval(this.statusRefreshInterval)}async loadSettings(){this.settings=Object.assign({},b,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}resetVaultListeners(){this.clearDebounce(),this.removeVaultListeners(),this.setupVaultListeners()}removeVaultListeners(){this.vaultEventRefs.forEach(t=>this.app.vault.offref(t)),this.vaultEventRefs=[]}setupVaultListeners(){if(!this.settings.autoCommit)return;if(c.Platform.isMobileApp){new c.Notice(m().noticeMobileNotSupported);return}let t=i=>this.onFileChange(i);this.vaultEventRefs.push(this.app.vault.on("create",t)),this.vaultEventRefs.push(this.app.vault.on("modify",t)),this.vaultEventRefs.push(this.app.vault.on("delete",t)),this.vaultEventRefs.push(this.app.vault.on("rename",t))}onFileChange(t){t instanceof c.TFile&&(this.shouldIgnore(t.path)||(this.scheduleCommit(),this.scheduleStatusRefresh()))}shouldIgnore(t){return!!(t.startsWith(".git/")||t.startsWith(".git\\")||this.settings.ignoreObsidianDir&&(t.startsWith(".obsidian/")||t.startsWith(".obsidian\\")))}scheduleCommit(){this.clearDebounce(),this.debounceTimer=window.setTimeout(()=>{this.debounceTimer=null,this.runCommit("auto")},this.settings.debounceSeconds*1e3)}clearDebounce(){this.debounceTimer!==null&&(window.clearTimeout(this.debounceTimer),this.debounceTimer=null)}getVaultPath(){let t=this.app.vault.adapter;if(!(t instanceof c.FileSystemAdapter))throw new Error(m().noticeDesktopOnly);return t.getBasePath()}getVaultPathSafe(){let t=this.app.vault.adapter;return t instanceof c.FileSystemAdapter?t.getBasePath():null}async runCommit(t){if(this.isCommitting)return this.pendingRerun=!0,!1;this.isCommitting=!0,this.pendingRerun=!1;let i=!1;try{let s=this.getVaultPath(),a=this.settings.gitPath,o=await P(s,a);if(o.length===0)return t==="manual"&&new c.Notice(m().noticeNoChanges),!1;let r=new Date,g=G(this.settings.commitTemplate,{date:r.toISOString().slice(0,10),time:r.toTimeString().slice(0,8),files:o.slice(0,5).join(", ")+(o.length>5?"...":""),count:String(o.length)}),l=g;this.settings.includeFileList&&(l=g+`

`+o.join(`
`)),await N(s,a,l),i=!0,new c.Notice(m().noticeCommitted(o.length)),this.settings.autoPush&&await this.doPush(),this.refreshStatusBadges()}catch(s){new c.Notice(m().noticeAutoGitError(s.message))}finally{this.isCommitting=!1,this.pendingRerun&&this.scheduleCommit()}return i}async doPush(){try{let t=this.getVaultPath();await D(t,this.settings.gitPath),new c.Notice(m().noticePushed)}catch(t){new c.Notice(m().noticePushFailed(t.message))}}setupStatusBadges(){c.Platform.isMobileApp||!this.settings.showStatusBadge||(this.refreshStatusBadges(),this.statusRefreshInterval=window.setInterval(()=>{this.refreshStatusBadges()},5e3))}scheduleStatusRefresh(){this.settings.showStatusBadge&&window.setTimeout(()=>this.refreshStatusBadges(),500)}refreshStatusBadges(){if(!this.settings.showStatusBadge){this.clearStatusBadges();return}let t=this.getVaultPathSafe();t&&T(t,this.settings.gitPath).then(i=>{this.currentStatuses=i,this.updateBadgesInDOM()})}clearStatusBadges(){document.querySelectorAll(".git-status-badge").forEach(t=>t.remove()),this.currentStatuses.clear()}updateBadgesInDOM(){document.querySelectorAll(".git-status-badge").forEach(i=>i.remove()),document.querySelectorAll(".nav-file-title").forEach(i=>{let s=i.getAttribute("data-path");if(!s)return;let a=this.currentStatuses.get(s);if(!a)return;let o=document.createElement("span");o.className="git-status-badge",o.textContent=a==="A"?"A":a,a==="M"?o.classList.add("modified"):a==="A"?o.classList.add("added"):a==="D"?o.classList.add("deleted"):a==="R"&&o.classList.add("renamed"),i.appendChild(o)})}};
