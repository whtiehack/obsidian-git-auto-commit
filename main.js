var ct=Object.create;var y=Object.defineProperty;var ut=Object.getOwnPropertyDescriptor;var mt=Object.getOwnPropertyNames;var dt=Object.getPrototypeOf,gt=Object.prototype.hasOwnProperty;var ht=(s,e)=>{for(var t in e)y(s,t,{get:e[t],enumerable:!0})},W=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of mt(e))!gt.call(s,n)&&n!==t&&y(s,n,{get:()=>e[n],enumerable:!(i=ut(e,n))||i.enumerable});return s};var pt=(s,e,t)=>(t=s!=null?ct(dt(s)):{},W(e||!s||!s.__esModule?y(t,"default",{value:s,enumerable:!0}):t,s)),ft=s=>W(y({},"__esModule",{value:!0}),s);var St={};ht(St,{default:()=>B});module.exports=ft(St);var d=require("obsidian");var l=require("obsidian");var wt={settingsTitle:"Auto Git Commit",sectionAutomation:"Automation",sectionConfiguration:"Configuration",sectionRepository:"Repository",autoCommitName:"Enable auto commit",autoCommitDesc:"Automatically commit when files change (debounced).",debounceName:"Debounce delay (seconds)",debounceDesc:"Wait time after last change before committing.",autoPushName:"Auto push after auto commit",autoPushDesc:"Push to remote after successful auto commit.",autoPullOnOpenName:"Auto pull on open",autoPullOnOpenDesc:"Pull from remote when Obsidian opens.",commitOnCloseName:"Commit and push on close",commitOnCloseDesc:"Commit all changes and push when Obsidian closes. Note: This may cause a brief delay when closing.",templateName:"Commit message template",templateDesc:"Variables: {{date}}, {{time}}, {{files}}, {{count}}",gitPathName:"Git binary path",gitPathDesc:"Path to git executable. Default: git",gitPathPlaceholder:"Path to git executable",ignoreObsidianName:"Ignore config directory",ignoreObsidianDesc:"Exclude Obsidian config folder from triggering auto-commits.",debugLogName:"Debug logging",debugLogDesc:"Log git commands to console (Ctrl+Shift+I to view).",includeFileListName:"Include file list in commit body",includeFileListDesc:"List changed files in commit message body, one per line.",showStatusBadgeName:"Show git status in file explorer",showStatusBadgeDesc:"Display colored dots next to changed files and folders.",badgeRefreshIntervalName:"Badge refresh interval (seconds)",badgeRefreshIntervalDesc:"Detect external git changes (e.g. terminal commands). Set to 0 if you only use Obsidian.",showRibbonButtonName:"Show ribbon button",showRibbonButtonDesc:"Add a ribbon icon for quick Git actions.",ribbonMenuPull:"Pull",ribbonMenuCommit:"Commit",ribbonMenuPush:"Push",ribbonMenuCommitAndPush:"Commit and push",ribbonMenuRevertAll:"Revert all changes",noticeReverted:"GitAutoCommit: All changes reverted.",noticeRevertFailed:s=>`GitAutoCommit: Revert failed - ${s}`,revertConfirmTitle:"Revert All Changes",revertConfirmDesc:"The following files will be reverted:",revertConfirmButton:"Revert",revertCancelButton:"Cancel",revertNoChanges:"No changes to revert.",revertFileMenu:"Revert file changes",noticeFileReverted:"GitAutoCommit: File reverted.",noticeFileRevertFailed:s=>`GitAutoCommit: Revert file failed - ${s}`,sectionSetup:"Setup",setupNotRepo:"Not a Git repository",setupEmptyRepo:"Empty repository (no commits)",setupLocalOnly:"Local only (no remote)",setupNoUpstream:"Remote configured (no upstream)",setupReady:"Ready",wizardConnectRemote:"Connect to remote repository",wizardConnectRemoteDesc:"Sync with an existing remote repository.",wizardConnectButton:"Connect",wizardInitAndPush:"Create new repository",wizardInitAndPushDesc:"Initialize and push to an empty remote.",wizardInitAndPushButton:"Create & Push",wizardLocalOnly:"Local version control only",wizardLocalOnlyDesc:"Just track changes locally without remote sync.",wizardLocalOnlyButton:"Initialize",wizardSetUpstream:"Set upstream branch",wizardSetUpstreamDesc:"Push current branch and set upstream tracking.",wizardSetUpstreamButton:"Set Upstream",noticeConnected:"GitAutoCommit: Connected to remote repository.",noticeConnectFailed:s=>`GitAutoCommit: Connect failed - ${s}`,noticeInitPushSuccess:"GitAutoCommit: Repository created and pushed.",noticeInitPushFailed:s=>`GitAutoCommit: Init/push failed - ${s}`,noticeUpstreamSet:"GitAutoCommit: Upstream branch set.",noticeUpstreamFailed:s=>`GitAutoCommit: Set upstream failed - ${s}`,repoStatusName:"Repository status",repoNotInitialized:"Not a git repository",repoInitialized:"Git repository initialized",initRepoButton:"Initialize repository",pullNowName:"Pull from remote",pullNowDesc:"Fetch and merge changes from the remote repository.",pullNowButton:"Pull",commitNowName:"Commit changes",commitNowDesc:"Commit all current changes.",commitNowButton:"Commit",pushNowName:"Push to remote",pushNowDesc:"Push commits to the remote repository.",pushNowButton:"Push",remoteUrlName:"Remote URL (origin)",remoteUrlDesc:"Set the remote repository URL for push.",remoteUrlPlaceholder:"https://github.com/user/repo.git",saveButton:"Save",conflictStatusName:"Merge conflicts detected",conflictStatusDesc:"Please resolve conflicts manually, then click the button below.",resolveConflictButton:"Mark as resolved",noticePulling:"GitAutoCommit: Pulling...",noticePushing:"GitAutoCommit: Pushing...",noticeCommitting:"GitAutoCommit: Committing...",noticeNoChanges:"GitAutoCommit: No changes to commit.",noticeCommitted:s=>`GitAutoCommit: Committed ${s} file(s).`,noticePushed:"GitAutoCommit: Pushed to remote.",noticePulled:"GitAutoCommit: Pulled from remote.",noticeAutoGitError:s=>`GitAutoCommit: Error - ${s}`,noticePushFailed:s=>`GitAutoCommit: Push failed - ${s}`,noticePullFailed:s=>`GitAutoCommit: Pull failed - ${s}`,noticeMobileNotSupported:"GitAutoCommit: Git not available on mobile.",noticeDesktopOnly:"GitAutoCommit: Requires desktop vault.",noticeRepoInitialized:"GitAutoCommit: Repository initialized.",noticeRemoteSaved:"GitAutoCommit: Remote URL saved.",noticeConflictDetected:"GitAutoCommit: Merge conflicts detected! Please resolve manually.",noticeConflictResolved:"GitAutoCommit: Conflicts marked as resolved.",noticeCannotCommitConflict:"GitAutoCommit: Cannot commit while conflicts exist."},I={settingsTitle:"\u81EA\u52A8 Git \u63D0\u4EA4",sectionAutomation:"\u81EA\u52A8\u5316",sectionConfiguration:"\u914D\u7F6E",sectionRepository:"\u4ED3\u5E93",autoCommitName:"\u542F\u7528\u81EA\u52A8\u63D0\u4EA4",autoCommitDesc:"\u6587\u4EF6\u53D8\u52A8\u540E\u81EA\u52A8\u63D0\u4EA4\uFF08\u9632\u6296\uFF09\u3002",debounceName:"\u9632\u6296\u5EF6\u8FDF\uFF08\u79D2\uFF09",debounceDesc:"\u6700\u540E\u4E00\u6B21\u53D8\u52A8\u540E\u7B49\u5F85\u591A\u4E45\u518D\u63D0\u4EA4\u3002",autoPushName:"\u81EA\u52A8\u63D0\u4EA4\u540E\u81EA\u52A8\u63A8\u9001",autoPushDesc:"\u81EA\u52A8\u63D0\u4EA4\u6210\u529F\u540E\u81EA\u52A8\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",autoPullOnOpenName:"\u6253\u5F00\u65F6\u81EA\u52A8\u62C9\u53D6",autoPullOnOpenDesc:"\u6253\u5F00 Obsidian \u65F6\u81EA\u52A8\u4ECE\u8FDC\u7A0B\u4ED3\u5E93\u62C9\u53D6\u3002",commitOnCloseName:"\u5173\u95ED\u65F6\u63D0\u4EA4\u5E76\u63A8\u9001",commitOnCloseDesc:"\u5173\u95ED Obsidian \u65F6\u81EA\u52A8\u63D0\u4EA4\u6240\u6709\u66F4\u6539\u5E76\u63A8\u9001\u3002\u6CE8\u610F\uFF1A\u8FD9\u53EF\u80FD\u5BFC\u81F4\u5173\u95ED\u65F6\u77ED\u6682\u5361\u987F\u3002",templateName:"\u63D0\u4EA4\u6D88\u606F\u6A21\u677F",templateDesc:"\u53D8\u91CF: {{date}}, {{time}}, {{files}}, {{count}}",gitPathName:"Git \u53EF\u6267\u884C\u6587\u4EF6\u8DEF\u5F84",gitPathDesc:"git \u7684\u8DEF\u5F84\uFF0C\u9ED8\u8BA4: git",gitPathPlaceholder:"git \u53EF\u6267\u884C\u6587\u4EF6\u8DEF\u5F84",ignoreObsidianName:"\u5FFD\u7565\u914D\u7F6E\u76EE\u5F55",ignoreObsidianDesc:"\u6392\u9664 Obsidian \u914D\u7F6E\u6587\u4EF6\u5939\u89E6\u53D1\u81EA\u52A8\u63D0\u4EA4\u3002",debugLogName:"\u8C03\u8BD5\u65E5\u5FD7",debugLogDesc:"\u5C06 git \u547D\u4EE4\u8F93\u51FA\u5230\u63A7\u5236\u53F0\uFF08Ctrl+Shift+I \u67E5\u770B\uFF09\u3002",includeFileListName:"\u5728\u63D0\u4EA4\u6B63\u6587\u4E2D\u5305\u542B\u6587\u4EF6\u5217\u8868",includeFileListDesc:"\u5728\u63D0\u4EA4\u6D88\u606F\u6B63\u6587\u4E2D\u5217\u51FA\u53D8\u52A8\u7684\u6587\u4EF6\uFF0C\u6BCF\u884C\u4E00\u4E2A\u3002",showStatusBadgeName:"\u5728\u6587\u4EF6\u5217\u8868\u663E\u793A Git \u72B6\u6001",showStatusBadgeDesc:"\u5728\u53D8\u52A8\u7684\u6587\u4EF6\u548C\u6587\u4EF6\u5939\u65C1\u663E\u793A\u5F69\u8272\u5706\u70B9\u3002",badgeRefreshIntervalName:"\u72B6\u6001\u5237\u65B0\u95F4\u9694\uFF08\u79D2\uFF09",badgeRefreshIntervalDesc:"\u7528\u4E8E\u68C0\u6D4B\u5916\u90E8 git \u64CD\u4F5C\uFF08\u5982\u7EC8\u7AEF\u547D\u4EE4\uFF09\u3002\u82E5\u53EA\u5728 Obsidian \u5185\u64CD\u4F5C\u53EF\u8BBE\u4E3A 0\u3002",showRibbonButtonName:"\u663E\u793A\u4FA7\u8FB9\u680F\u6309\u94AE",showRibbonButtonDesc:"\u6DFB\u52A0\u5FEB\u6377 Git \u64CD\u4F5C\u6309\u94AE\u3002",ribbonMenuPull:"\u62C9\u53D6",ribbonMenuCommit:"\u63D0\u4EA4",ribbonMenuPush:"\u63A8\u9001",ribbonMenuCommitAndPush:"\u63D0\u4EA4\u5E76\u63A8\u9001",ribbonMenuRevertAll:"\u8FD8\u539F\u6240\u6709\u4FEE\u6539",noticeReverted:"GitAutoCommit: \u5DF2\u8FD8\u539F\u6240\u6709\u4FEE\u6539\u3002",noticeRevertFailed:s=>`GitAutoCommit: \u8FD8\u539F\u5931\u8D25 - ${s}`,revertConfirmTitle:"\u8FD8\u539F\u6240\u6709\u4FEE\u6539",revertConfirmDesc:"\u4EE5\u4E0B\u6587\u4EF6\u5C06\u88AB\u8FD8\u539F\uFF1A",revertConfirmButton:"\u8FD8\u539F",revertCancelButton:"\u53D6\u6D88",revertNoChanges:"\u6CA1\u6709\u53EF\u8FD8\u539F\u7684\u4FEE\u6539\u3002",revertFileMenu:"\u8FD8\u539F\u6587\u4EF6\u4FEE\u6539",noticeFileReverted:"GitAutoCommit: \u6587\u4EF6\u5DF2\u8FD8\u539F\u3002",noticeFileRevertFailed:s=>`GitAutoCommit: \u8FD8\u539F\u6587\u4EF6\u5931\u8D25 - ${s}`,sectionSetup:"\u521D\u59CB\u8BBE\u7F6E",setupNotRepo:"\u5C1A\u672A\u521D\u59CB\u5316\u4E3A Git \u4ED3\u5E93",setupEmptyRepo:"\u7A7A\u4ED3\u5E93\uFF08\u65E0\u63D0\u4EA4\uFF09",setupLocalOnly:"\u4EC5\u672C\u5730\uFF08\u65E0\u8FDC\u7A0B\uFF09",setupNoUpstream:"\u5DF2\u914D\u7F6E\u8FDC\u7A0B\uFF08\u65E0\u4E0A\u6E38\u5206\u652F\uFF09",setupReady:"\u5C31\u7EEA",wizardConnectRemote:"\u8FDE\u63A5\u8FDC\u7A0B\u4ED3\u5E93",wizardConnectRemoteDesc:"\u540C\u6B65\u5230\u5DF2\u6709\u7684\u8FDC\u7A0B\u4ED3\u5E93\u3002",wizardConnectButton:"\u8FDE\u63A5",wizardInitAndPush:"\u521B\u5EFA\u65B0\u4ED3\u5E93",wizardInitAndPushDesc:"\u521D\u59CB\u5316\u5E76\u63A8\u9001\u5230\u7A7A\u7684\u8FDC\u7A0B\u4ED3\u5E93\u3002",wizardInitAndPushButton:"\u521B\u5EFA\u5E76\u63A8\u9001",wizardLocalOnly:"\u4EC5\u672C\u5730\u7248\u672C\u63A7\u5236",wizardLocalOnlyDesc:"\u4EC5\u5728\u672C\u5730\u8DDF\u8E2A\u53D8\u66F4\uFF0C\u4E0D\u540C\u6B65\u8FDC\u7A0B\u3002",wizardLocalOnlyButton:"\u521D\u59CB\u5316",wizardSetUpstream:"\u8BBE\u7F6E\u4E0A\u6E38\u5206\u652F",wizardSetUpstreamDesc:"\u63A8\u9001\u5F53\u524D\u5206\u652F\u5E76\u8BBE\u7F6E\u4E0A\u6E38\u8DDF\u8E2A\u3002",wizardSetUpstreamButton:"\u8BBE\u7F6E\u4E0A\u6E38",noticeConnected:"GitAutoCommit: \u5DF2\u8FDE\u63A5\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",noticeConnectFailed:s=>`GitAutoCommit: \u8FDE\u63A5\u5931\u8D25 - ${s}`,noticeInitPushSuccess:"GitAutoCommit: \u4ED3\u5E93\u5DF2\u521B\u5EFA\u5E76\u63A8\u9001\u3002",noticeInitPushFailed:s=>`GitAutoCommit: \u521D\u59CB\u5316/\u63A8\u9001\u5931\u8D25 - ${s}`,noticeUpstreamSet:"GitAutoCommit: \u5DF2\u8BBE\u7F6E\u4E0A\u6E38\u5206\u652F\u3002",noticeUpstreamFailed:s=>`GitAutoCommit: \u8BBE\u7F6E\u4E0A\u6E38\u5931\u8D25 - ${s}`,repoStatusName:"\u4ED3\u5E93\u72B6\u6001",repoNotInitialized:"\u5C1A\u672A\u521D\u59CB\u5316\u4E3A Git \u4ED3\u5E93",repoInitialized:"Git \u4ED3\u5E93\u5DF2\u521D\u59CB\u5316",initRepoButton:"\u521D\u59CB\u5316\u4ED3\u5E93",pullNowName:"\u4ECE\u8FDC\u7A0B\u62C9\u53D6",pullNowDesc:"\u4ECE\u8FDC\u7A0B\u4ED3\u5E93\u83B7\u53D6\u5E76\u5408\u5E76\u66F4\u6539\u3002",pullNowButton:"\u62C9\u53D6",commitNowName:"\u63D0\u4EA4\u66F4\u6539",commitNowDesc:"\u63D0\u4EA4\u6240\u6709\u5F53\u524D\u66F4\u6539\u3002",commitNowButton:"\u63D0\u4EA4",pushNowName:"\u63A8\u9001\u5230\u8FDC\u7A0B",pushNowDesc:"\u5C06\u63D0\u4EA4\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",pushNowButton:"\u63A8\u9001",remoteUrlName:"\u8FDC\u7A0B\u4ED3\u5E93\u5730\u5740 (origin)",remoteUrlDesc:"\u8BBE\u7F6E\u7528\u4E8E\u63A8\u9001\u7684\u8FDC\u7A0B\u4ED3\u5E93\u5730\u5740\u3002",remoteUrlPlaceholder:"https://github.com/user/repo.git",saveButton:"\u4FDD\u5B58",conflictStatusName:"\u68C0\u6D4B\u5230\u5408\u5E76\u51B2\u7A81",conflictStatusDesc:"\u8BF7\u624B\u52A8\u89E3\u51B3\u51B2\u7A81\u540E\uFF0C\u70B9\u51FB\u4E0B\u65B9\u6309\u94AE\u3002",resolveConflictButton:"\u6807\u8BB0\u4E3A\u5DF2\u89E3\u51B3",noticePulling:"GitAutoCommit: \u6B63\u5728\u62C9\u53D6...",noticePushing:"GitAutoCommit: \u6B63\u5728\u63A8\u9001...",noticeCommitting:"GitAutoCommit: \u6B63\u5728\u63D0\u4EA4...",noticeNoChanges:"GitAutoCommit: \u6CA1\u6709\u53EF\u63D0\u4EA4\u7684\u66F4\u6539\u3002",noticeCommitted:s=>`GitAutoCommit: \u5DF2\u63D0\u4EA4 ${s} \u4E2A\u6587\u4EF6\u3002`,noticePushed:"GitAutoCommit: \u5DF2\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",noticePulled:"GitAutoCommit: \u5DF2\u4ECE\u8FDC\u7A0B\u4ED3\u5E93\u62C9\u53D6\u3002",noticeAutoGitError:s=>`GitAutoCommit: \u9519\u8BEF - ${s}`,noticePushFailed:s=>`GitAutoCommit: \u63A8\u9001\u5931\u8D25 - ${s}`,noticePullFailed:s=>`GitAutoCommit: \u62C9\u53D6\u5931\u8D25 - ${s}`,noticeMobileNotSupported:"GitAutoCommit: \u79FB\u52A8\u7AEF\u4E0D\u652F\u6301 Git\u3002",noticeDesktopOnly:"GitAutoCommit: \u9700\u8981\u684C\u9762\u7AEF\u3002",noticeRepoInitialized:"GitAutoCommit: \u4ED3\u5E93\u5DF2\u521D\u59CB\u5316\u3002",noticeRemoteSaved:"GitAutoCommit: \u8FDC\u7A0B\u5730\u5740\u5DF2\u4FDD\u5B58\u3002",noticeConflictDetected:"GitAutoCommit: \u68C0\u6D4B\u5230\u5408\u5E76\u51B2\u7A81\uFF01\u8BF7\u624B\u52A8\u89E3\u51B3\u3002",noticeConflictResolved:"GitAutoCommit: \u51B2\u7A81\u5DF2\u6807\u8BB0\u4E3A\u89E3\u51B3\u3002",noticeCannotCommitConflict:"GitAutoCommit: \u5B58\u5728\u51B2\u7A81\u65F6\u65E0\u6CD5\u63D0\u4EA4\u3002"},_={en:wt,zh:I,"zh-CN":I,"zh-TW":I};function bt(){return window.localStorage.getItem("language")||"en"}function g(){let s=bt();return _[s]||_.en}var p=require("child_process"),E=require("fs"),w=pt(require("path")),O=!1;function P(s){O=s}function S(s,...e){O&&console.debug(`[auto-git] ${s}`,...e)}function J(s){O&&console.debug(`[auto-git] > git ${s.join(" ")}`)}function Ct(){var e;let s={...process.env,GIT_TERMINAL_PROMPT:"0"};if(process.platform==="darwin"){let t=["/usr/local/bin","/opt/homebrew/bin","/usr/local/sbin","/opt/homebrew/sbin"],n=((e=s.PATH)!=null?e:"").split(w.delimiter).filter(Boolean),o=n.map(a=>a.replace(/\/+$/,"")),r=t.filter(a=>!o.includes(a));r.length>0&&(s.PATH=[...n,...r].join(w.delimiter))}return s}var F=null;function T(){return F||(F=Ct()),F}function G({cwd:s,gitPath:e,args:t}){J(t);try{let i=(0,p.execFileSync)(e,t,{cwd:s,windowsHide:!0,env:T(),encoding:"utf8"});return S("ok"),i}catch(i){throw S("error:",i.message),i}}function u({cwd:s,gitPath:e,args:t}){return J(t),new Promise((i,n)=>{(0,p.execFile)(e,t,{cwd:s,windowsHide:!0,env:T()},(o,r,a)=>{if(o){S("error:",(a==null?void 0:a.trim())||o.message),n(new Error((a==null?void 0:a.trim())||o.message));return}S("ok"),i(r)})})}async function L(s,e){if(!e)return;let t=w.join(s,".gitignore"),i=e.endsWith("/")?e:`${e}/`,n="";try{n=await E.promises.readFile(t,"utf8")}catch(m){if(m.code!=="ENOENT")throw m}if(n.split(/\r?\n/).some(m=>m.trim()===i))return;let r=n.includes(`\r
`)?`\r
`:`
`,a=n.length>0&&!n.endsWith(`
`)?r:"";await E.promises.writeFile(t,`${n}${a}${i}${r}`,"utf8")}async function M(s,e){if(!await R(s,e))return"not-a-repo";try{await u({cwd:s,gitPath:e,args:["rev-parse","HEAD"]})}catch(i){return"empty-repo"}if(!await b(s,e))return"local-only";try{return await u({cwd:s,gitPath:e,args:["rev-parse","--abbrev-ref","@{u}"]}),"ready"}catch(i){return"remote-no-upstream"}}async function x(s,e){let t=await u({cwd:s,gitPath:e,args:["status","--porcelain=v1","-z"]});if(!t)return[];let i=t.split("\0").filter(Boolean),n=[];for(let o=0;o<i.length;o++){let r=i[o],a=r.slice(0,2),m=r.slice(3);if(a.startsWith("R")||a.startsWith("C")){let c=i[++o];c&&n.push(c);continue}m&&n.push(m)}return[...new Set(n)]}async function Z(s,e,t){await u({cwd:s,gitPath:e,args:["add","-A"]});try{await u({cwd:s,gitPath:e,args:["commit","-m",t]})}catch(i){let n=i.message;if(n.includes("nothing to commit")||n.includes("no changes added"))return;throw i}}async function K(s,e){let t=await $(s,e);await u({cwd:s,gitPath:e,args:["push","-u","origin",t]})}async function Q(s,e){let t=await M(s,e);if(t!=="ready")return{success:!1,hasConflicts:!1,message:`Repository not ready: ${t}`,notReady:!0};try{try{return{success:!0,hasConflicts:!1,message:await u({cwd:s,gitPath:e,args:["pull"]})}}catch(i){let n=await $(s,e);return{success:!0,hasConflicts:!1,message:await u({cwd:s,gitPath:e,args:["pull","origin",n]})}}}catch(i){let n=i.message;if(n.includes("CONFLICT")||n.includes("Merge conflict"))return{success:!1,hasConflicts:!0,message:n};throw i}}async function z(s,e){try{return(await u({cwd:s,gitPath:e,args:["diff","--name-only","--diff-filter=U"]})).split(`
`).map(i=>i.trim()).filter(Boolean)}catch(t){return[]}}async function X(s,e){return(await z(s,e)).length>0}async function N(s,e){await u({cwd:s,gitPath:e,args:["add","-A"]})}async function R(s,e){try{return await u({cwd:s,gitPath:e,args:["rev-parse","--git-dir"]}),!0}catch(t){return!1}}async function k(s,e,t){await u({cwd:s,gitPath:e,args:["init"]}),await L(s,t)}async function b(s,e){try{return(await u({cwd:s,gitPath:e,args:["remote","get-url","origin"]})).trim()}catch(t){return""}}async function U(s,e,t){await b(s,e)?await u({cwd:s,gitPath:e,args:["remote","set-url","origin",t]}):await u({cwd:s,gitPath:e,args:["remote","add","origin",t]})}async function Y(s,e){await u({cwd:s,gitPath:e,args:["checkout","--","."]}),await u({cwd:s,gitPath:e,args:["clean","-fd"]})}async function tt(s,e,t){try{await u({cwd:s,gitPath:e,args:["checkout","--",t]})}catch(i){await u({cwd:s,gitPath:e,args:["clean","-f","--",t]})}}function vt(s){let e=new Map;if(!s)return e;let t=s.split("\0").filter(Boolean);for(let i=0;i<t.length;i++){let n=t[i],o=n.slice(0,2),r=n.slice(3);if(o.includes("R")||o.includes("C")){let m=t[++i];m&&(r=m)}let a="";o.includes("U")?a="U":o==="??"||o.includes("A")?a="A":o.includes("M")?a="M":(o.includes("R")||o.includes("C"))&&(a="R"),r&&a&&e.set(r,a)}return e}async function et(s,e){try{let t=await u({cwd:s,gitPath:e,args:["status","--porcelain=v1","-z"]});return vt(t)}catch(t){return new Map}}async function it(s,e){let t=new Set;try{let i=await u({cwd:s,gitPath:e,args:["ls-files","-z"]});i&&i.split("\0").filter(Boolean).forEach(n=>t.add(n))}catch(i){}return t}async function yt(s,e){try{let i=(await u({cwd:s,gitPath:e,args:["remote","show","origin"]})).match(/HEAD branch:\s*(\S+)/);if(i&&i[1]!=="(unknown)")return i[1]}catch(t){}try{let t=await u({cwd:s,gitPath:e,args:["ls-remote","--heads","origin"]});if(!t.trim())return null;if(t.includes("refs/heads/main"))return"main";if(t.includes("refs/heads/master"))return"master";let i=t.match(/refs\/heads\/(\S+)/);if(i)return i[1]}catch(t){}return null}async function st(s,e,t,i="main",n){await u({cwd:s,gitPath:e,args:["init","-b",i]}),await L(s,n),await u({cwd:s,gitPath:e,args:["add","-A"]}),await u({cwd:s,gitPath:e,args:["commit","-m","Initial commit"]}),await u({cwd:s,gitPath:e,args:["remote","add","origin",t]}),await u({cwd:s,gitPath:e,args:["push","-u","origin",i]})}async function nt(s,e,t,i){await R(s,e)||await u({cwd:s,gitPath:e,args:["init","-b","main"]});let n=await b(s,e);n?n!==t&&await u({cwd:s,gitPath:e,args:["remote","set-url","origin",t]}):await u({cwd:s,gitPath:e,args:["remote","add","origin",t]}),await u({cwd:s,gitPath:e,args:["fetch","origin"]});let o=await yt(s,e);if(!o){await L(s,i),await u({cwd:s,gitPath:e,args:["add","-A"]});try{await u({cwd:s,gitPath:e,args:["commit","-m","Initial commit"]})}catch(a){if(!a.message.includes("nothing to commit"))throw a}return await u({cwd:s,gitPath:e,args:["push","-u","origin","main"]}),{branch:"main"}}let r=!1;try{await u({cwd:s,gitPath:e,args:["rev-parse","HEAD"]}),r=!0}catch(a){r=!1}if(!r)await u({cwd:s,gitPath:e,args:["checkout","-b",o,`origin/${o}`]});else{try{await u({cwd:s,gitPath:e,args:["branch","-M",o]})}catch(a){}await u({cwd:s,gitPath:e,args:["branch",`--set-upstream-to=origin/${o}`,o]})}return{branch:o}}async function V(s,e){let t=await $(s,e);await u({cwd:s,gitPath:e,args:["push","-u","origin",t]})}async function $(s,e){return(await u({cwd:s,gitPath:e,args:["rev-parse","--abbrev-ref","HEAD"]})).trim()}function ot(s,e){try{let t=G({cwd:s,gitPath:e,args:["status","--porcelain=v1","-z"]});if(!t)return[];let i=t.split("\0").filter(Boolean),n=[];for(let o=0;o<i.length;o++){let r=i[o],a=r.slice(0,2),m=r.slice(3);if(a.startsWith("R")||a.startsWith("C")){let c=i[++o];c&&n.push(c);continue}m&&n.push(m)}return[...new Set(n)]}catch(t){return[]}}function at(s,e,t){try{G({cwd:s,gitPath:e,args:["add","-A"]}),G({cwd:s,gitPath:e,args:["commit","-m",t]})}catch(i){return}try{(0,p.spawn)(e,["push"],{cwd:s,detached:!0,stdio:"ignore",windowsHide:!0,env:T()}).unref()}catch(i){}}var H={autoCommit:!1,debounceSeconds:30,commitTemplate:"vault backup: {{date}} {{time}}",includeFileList:!0,autoPush:!1,autoPullOnOpen:!1,commitOnClose:!1,gitPath:"git",ignoreObsidianDir:!0,showStatusBadge:!0,showRibbonButton:!0,badgeRefreshInterval:0,debugLog:!1},D=class extends l.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this,t=g();if(e.empty(),new l.Setting(e).setName(t.settingsTitle).setHeading(),!l.Platform.isMobileApp){let n=e.createDiv();this.displaySetupSection(n)}if(!l.Platform.isMobileApp){new l.Setting(e).setName(t.sectionRepository).setHeading();let n=e.createDiv();this.displayRepoSection(n)}new l.Setting(e).setName(t.sectionAutomation).setHeading(),new l.Setting(e).setName(t.autoPullOnOpenName).setDesc(t.autoPullOnOpenDesc).addToggle(n=>n.setValue(this.plugin.settings.autoPullOnOpen).onChange(async o=>{this.plugin.settings.autoPullOnOpen=o,await this.plugin.saveSettings()})),new l.Setting(e).setName(t.commitOnCloseName).setDesc(t.commitOnCloseDesc).addToggle(n=>n.setValue(this.plugin.settings.commitOnClose).onChange(async o=>{this.plugin.settings.commitOnClose=o,await this.plugin.saveSettings()}));let i;new l.Setting(e).setName(t.autoCommitName).setDesc(t.autoCommitDesc).addToggle(n=>n.setValue(this.plugin.settings.autoCommit).onChange(async o=>{this.plugin.settings.autoCommit=o,await this.plugin.saveSettings(),this.plugin.resetVaultListeners(),i.style.display=o?"block":"none"})),i=e.createDiv(),i.style.display=this.plugin.settings.autoCommit?"block":"none",new l.Setting(i).setName(t.debounceName).setDesc(t.debounceDesc).addText(n=>n.setPlaceholder("30").setValue(String(this.plugin.settings.debounceSeconds)).onChange(async o=>{let r=parseInt(o);!isNaN(r)&&r>=5&&(this.plugin.settings.debounceSeconds=r,await this.plugin.saveSettings())})),new l.Setting(i).setName(t.autoPushName).setDesc(t.autoPushDesc).addToggle(n=>n.setValue(this.plugin.settings.autoPush).onChange(async o=>{this.plugin.settings.autoPush=o,await this.plugin.saveSettings()})),new l.Setting(e).setName(t.sectionConfiguration).setHeading(),new l.Setting(e).setName(t.templateName).setDesc(t.templateDesc).addTextArea(n=>n.setPlaceholder("vault backup: {{date}} {{time}}").setValue(this.plugin.settings.commitTemplate).onChange(async o=>{this.plugin.settings.commitTemplate=o,await this.plugin.saveSettings()})),new l.Setting(e).setName(t.includeFileListName).setDesc(t.includeFileListDesc).addToggle(n=>n.setValue(this.plugin.settings.includeFileList).onChange(async o=>{this.plugin.settings.includeFileList=o,await this.plugin.saveSettings()})),new l.Setting(e).setName(t.showStatusBadgeName).setDesc(t.showStatusBadgeDesc).addToggle(n=>n.setValue(this.plugin.settings.showStatusBadge).onChange(async o=>{this.plugin.settings.showStatusBadge=o,await this.plugin.saveSettings(),this.plugin.updateStatusBadges()})),new l.Setting(e).setName(t.badgeRefreshIntervalName).setDesc(t.badgeRefreshIntervalDesc).addText(n=>n.setPlaceholder("10").setValue(String(this.plugin.settings.badgeRefreshInterval)).onChange(async o=>{let r=parseInt(o);!isNaN(r)&&r>=0&&(this.plugin.settings.badgeRefreshInterval=r,await this.plugin.saveSettings(),this.plugin.updateStatusBadges())})),new l.Setting(e).setName(t.showRibbonButtonName).setDesc(t.showRibbonButtonDesc).addToggle(n=>n.setValue(this.plugin.settings.showRibbonButton).onChange(async o=>{this.plugin.settings.showRibbonButton=o,await this.plugin.saveSettings(),this.plugin.updateRibbonButton()})),new l.Setting(e).setName(t.gitPathName).setDesc(t.gitPathDesc).addText(n=>n.setPlaceholder(t.gitPathPlaceholder).setValue(this.plugin.settings.gitPath).onChange(async o=>{this.plugin.settings.gitPath=o.trim()||"git",await this.plugin.saveSettings()})),new l.Setting(e).setName(t.ignoreObsidianName).setDesc(t.ignoreObsidianDesc).addToggle(n=>n.setValue(this.plugin.settings.ignoreObsidianDir).onChange(async o=>{this.plugin.settings.ignoreObsidianDir=o,await this.plugin.saveSettings()})),new l.Setting(e).setName(t.debugLogName).setDesc(t.debugLogDesc).addToggle(n=>n.setValue(this.plugin.settings.debugLog).onChange(async o=>{this.plugin.settings.debugLog=o,P(o),await this.plugin.saveSettings()}))}async displaySetupSection(e){let t=g(),i=this.plugin.getVaultPathSafe();if(!i){e.empty();return}let n=this.plugin.settings.gitPath,o=await M(i,n);if(e.empty(),o==="ready")return;new l.Setting(e).setName(t.sectionSetup).setHeading();let r={"not-a-repo":t.setupNotRepo,"empty-repo":t.setupEmptyRepo,"local-only":t.setupLocalOnly,"remote-no-upstream":t.setupNoUpstream,ready:t.setupReady};if(new l.Setting(e).setName(t.repoStatusName).setDesc(r[o]),o==="not-a-repo"||o==="empty-repo"){let a="",m="";new l.Setting(e).setName(t.wizardConnectRemote).setDesc(t.wizardConnectRemoteDesc).addText(c=>c.setPlaceholder(t.remoteUrlPlaceholder).onChange(h=>{a=h.trim()})).addButton(c=>c.setButtonText(t.wizardConnectButton).onClick(async()=>{if(a)try{let h=this.plugin.settings.ignoreObsidianDir?this.app.vault.configDir:void 0;await nt(i,n,a,h),new l.Notice(t.noticeConnected),this.display(),this.plugin.refreshStatusBadges()}catch(h){new l.Notice(t.noticeConnectFailed(h.message))}})),new l.Setting(e).setName(t.wizardInitAndPush).setDesc(t.wizardInitAndPushDesc).addText(c=>c.setPlaceholder(t.remoteUrlPlaceholder).onChange(h=>{m=h.trim()})).addButton(c=>c.setButtonText(t.wizardInitAndPushButton).onClick(async()=>{if(m)try{let h=this.plugin.settings.ignoreObsidianDir?this.app.vault.configDir:void 0;await st(i,n,m,"main",h),new l.Notice(t.noticeInitPushSuccess),this.display(),this.plugin.refreshStatusBadges()}catch(h){new l.Notice(t.noticeInitPushFailed(h.message))}})),o==="not-a-repo"&&new l.Setting(e).setName(t.wizardLocalOnly).setDesc(t.wizardLocalOnlyDesc).addButton(c=>c.setButtonText(t.wizardLocalOnlyButton).onClick(async()=>{try{let h=this.plugin.settings.ignoreObsidianDir?this.app.vault.configDir:void 0;await k(i,n,h),new l.Notice(t.noticeRepoInitialized),this.display()}catch(h){new l.Notice(h.message)}}))}else if(o==="local-only"){let a="";new l.Setting(e).setName(t.wizardInitAndPush).setDesc(t.wizardInitAndPushDesc).addText(m=>m.setPlaceholder(t.remoteUrlPlaceholder).onChange(c=>{a=c.trim()})).addButton(m=>m.setButtonText(t.wizardSetUpstreamButton).onClick(async()=>{if(a)try{await U(i,n,a),await V(i,n),new l.Notice(t.noticeUpstreamSet),this.display()}catch(c){new l.Notice(t.noticeUpstreamFailed(c.message))}}))}else o==="remote-no-upstream"&&new l.Setting(e).setName(t.wizardSetUpstream).setDesc(t.wizardSetUpstreamDesc).addButton(a=>a.setButtonText(t.wizardSetUpstreamButton).onClick(async()=>{try{await V(i,n),new l.Notice(t.noticeUpstreamSet),this.display()}catch(m){new l.Notice(t.noticeUpstreamFailed(m.message))}}))}async displayRepoSection(e){let t=g(),i=this.plugin.getVaultPathSafe();if(!i){e.empty();return}let n=this.plugin.settings.gitPath,[o,r,a]=await Promise.all([R(i,n),b(i,n),X(i,n)]);if(e.empty(),!o)new l.Setting(e).setName(t.repoStatusName).setDesc(t.repoNotInitialized).addButton(m=>m.setButtonText(t.initRepoButton).onClick(async()=>{try{let c=this.plugin.settings.ignoreObsidianDir?this.app.vault.configDir:void 0;await k(i,n,c),new l.Notice(t.noticeRepoInitialized),this.display()}catch(c){new l.Notice(c.message)}}));else{new l.Setting(e).setName(t.repoStatusName).setDesc(t.repoInitialized),new l.Setting(e).setName(t.pullNowName).setDesc(t.pullNowDesc).addButton(c=>c.setButtonText(t.pullNowButton).onClick(async()=>{await this.plugin.doPull(),this.display()})),new l.Setting(e).setName(t.commitNowName).setDesc(t.commitNowDesc).addButton(c=>c.setButtonText(t.commitNowButton).onClick(async()=>{await this.plugin.runCommit("manual")})),new l.Setting(e).setName(t.pushNowName).setDesc(t.pushNowDesc).addButton(c=>c.setButtonText(t.pushNowButton).onClick(async()=>{await this.plugin.doPush()}));let m=r;new l.Setting(e).setName(t.remoteUrlName).setDesc(t.remoteUrlDesc).addText(c=>c.setPlaceholder(t.remoteUrlPlaceholder).setValue(r).onChange(h=>{m=h.trim()})).addButton(c=>c.setButtonText(t.saveButton).onClick(async()=>{if(m)try{await U(i,n,m),new l.Notice(t.noticeRemoteSaved)}catch(h){new l.Notice(h.message)}})),a&&new l.Setting(e).setName(t.conflictStatusName).setDesc(t.conflictStatusDesc).addButton(c=>c.setButtonText(t.resolveConflictButton).setWarning().onClick(async()=>{try{await N(i,n),this.plugin.setHasConflicts(!1),new l.Notice(t.noticeConflictResolved),this.display()}catch(h){new l.Notice(h.message)}}))}}};function q(s,e){return s.replace(/\{\{\s*([a-zA-Z0-9_]+)\s*\}\}/g,(t,i)=>{var n;return(n=e[i])!=null?n:""})}var rt=require("obsidian");var C=class extends rt.Modal{constructor(e,t,i){super(e),this.files=t,this.onConfirm=i}onOpen(){let e=g(),{contentEl:t}=this;t.createEl("h2",{text:e.revertConfirmTitle}),t.createEl("p",{text:e.revertConfirmDesc});let i=t.createEl("ul",{cls:"revert-file-list"});this.files.forEach(r=>{i.createEl("li",{text:r})});let n=t.createDiv({cls:"modal-button-container"});n.createEl("button",{text:e.revertCancelButton}).addEventListener("click",()=>{this.close()}),n.createEl("button",{text:e.revertConfirmButton,cls:"mod-warning"}).addEventListener("click",()=>{this.close(),this.onConfirm()})}onClose(){this.contentEl.empty()}};var A=class{constructor(e){this.opts=e;this.enabled=!1;this.pollInterval=0;this.fileStatuses=new Map;this.folderStatuses=new Map;this.trackedFiles=new Set;this.trackedLoaded=!1;this.conflicts=new Set;this.pollId=null;this.retryId=null;this.rafId=null;this.observer=null}start(e,t){this.stop(),this.enabled=e,this.pollInterval=t,this.enabled&&(this.attachObserver(0),this.refresh(),this.pollInterval>0&&(this.pollId=window.setInterval(()=>{this.refresh()},this.pollInterval*1e3)))}stop(){this.enabled=!1,this.pollId&&(window.clearInterval(this.pollId),this.pollId=null),this.retryId&&(window.clearTimeout(this.retryId),this.retryId=null),this.rafId&&(window.cancelAnimationFrame(this.rafId),this.rafId=null),this.observer&&(this.observer.disconnect(),this.observer=null),this.fileStatuses.clear(),this.folderStatuses.clear(),this.trackedFiles.clear(),this.trackedLoaded=!1,this.conflicts.clear(),this.clearDom()}setConflicts(e){this.conflicts=new Set([...e].filter(t=>!this.opts.shouldIgnore(t))),this.rebuildFolderStatuses(),this.queueRender()}getStatus(e){var t;return!this.enabled||this.opts.shouldIgnore(e)?"":this.conflicts.has(e)?"U":(t=this.fileStatuses.get(e))!=null?t:""}noteCreate(e){!this.enabled||this.opts.shouldIgnore(e)||this.trackedLoaded&&(this.fileStatuses.set(e,this.trackedFiles.has(e)?"M":"A"),this.rebuildFolderStatuses(),this.queueRender())}noteModify(e){if(!this.enabled||this.opts.shouldIgnore(e)||!this.trackedLoaded)return;let t=this.fileStatuses.get(e);t==="A"||t==="R"||(this.fileStatuses.set(e,"M"),this.rebuildFolderStatuses(),this.queueRender())}noteDelete(e){!this.enabled||this.opts.shouldIgnore(e)||(this.fileStatuses.delete(e),this.conflicts.delete(e),this.rebuildFolderStatuses(),this.queueRender())}noteRename(e,t){if(this.enabled&&!(this.opts.shouldIgnore(e)&&this.opts.shouldIgnore(t))){if(this.fileStatuses.delete(e),this.conflicts.delete(e),!this.opts.shouldIgnore(t)&&this.trackedLoaded){let i=this.trackedFiles.has(e);i&&(this.trackedFiles.delete(e),this.trackedFiles.add(t)),this.fileStatuses.set(t,i?"R":"A")}this.rebuildFolderStatuses(),this.queueRender()}}async refresh(){if(!this.enabled)return;let e=this.opts.getCwd();if(e)try{let[t,i]=await Promise.all([et(e,this.opts.getGitPath()),it(e,this.opts.getGitPath())]);if(!this.enabled)return;this.fileStatuses=new Map([...t].filter(([n])=>!this.opts.shouldIgnore(n))),this.trackedFiles=i,this.trackedLoaded=!0,this.rebuildFolderStatuses(),this.queueRender()}catch(t){}}attachObserver(e){if(!this.enabled)return;let t=document.querySelector(".nav-files-container");if(!t){e<10&&(this.retryId=window.setTimeout(()=>{this.retryId=null,this.attachObserver(e+1)},200));return}this.observer=new MutationObserver(()=>this.queueRender()),this.observer.observe(t,{childList:!0,subtree:!0}),this.queueRender()}queueRender(){!this.enabled||this.rafId||(this.rafId=window.requestAnimationFrame(()=>{this.rafId=null,this.render()}))}render(){this.enabled&&document.querySelectorAll(".nav-file-title[data-path], .nav-folder-title[data-path]").forEach(e=>{var o,r;let t=e.getAttribute("data-path");if(!t)return;let i=e.querySelector(".git-status-badge");if(this.opts.shouldIgnore(t)){i&&i.remove();return}let n="";e.classList.contains("nav-file-title")?n=this.conflicts.has(t)?"U":(o=this.fileStatuses.get(t))!=null?o:"":n=(r=this.folderStatuses.get(t))!=null?r:"",n?(i||(i=document.createElement("span"),i.className="git-status-badge",e.appendChild(i)),i.setAttribute("data-status",n)):i&&i.remove()})}clearDom(){document.querySelectorAll(".git-status-badge").forEach(e=>e.remove())}rebuildFolderStatuses(){let e=new Map(this.fileStatuses);this.conflicts.forEach(i=>e.set(i,"U"));let t=new Map;e.forEach((i,n)=>{let o=n.split(/[/\\]/);for(let r=1;r<o.length;r++){let a=o.slice(0,r).join("/"),m=t.get(a);(!m||this.priority(i)>this.priority(m))&&t.set(a,i)}}),this.folderStatuses=t}priority(e){switch(e){case"U":return 4;case"A":return 3;case"M":return 2;case"R":return 1;default:return 0}}};var lt=require("obsidian"),f=class{constructor(e){var t;this.notice=new lt.Notice(e,0),(t=this.notice.messageEl.parentElement)==null||t.addClass("is-loading")}succeed(e,t=3e3){let i=this.notice.messageEl.parentElement;i==null||i.removeClass("is-loading"),i==null||i.addClass("mod-success"),this.notice.setMessage(e),window.setTimeout(()=>this.notice.hide(),t)}fail(e,t=5e3){var i;(i=this.notice.messageEl.parentElement)==null||i.removeClass("is-loading"),this.notice.setMessage(e),window.setTimeout(()=>this.notice.hide(),t)}};var B=class extends d.Plugin{constructor(){super(...arguments);this.settings=H;this.debounceTimer=null;this.isCommitting=!1;this.pendingRerun=!1;this.vaultEventRefs=[];this.conflictFiles=new Set;this._hasConflicts=!1;this.resolveConflictCommand=null;this.ribbonIconEl=null;this.beforeUnloadHandler=null;this.statusBadges=null}async onload(){await this.loadSettings(),this.addSettingTab(new D(this.app,this)),this.updateRibbonButton(),this.addCommand({id:"commit-now",name:"Commit now",callback:()=>{this.runCommit("manual")}}),this.addCommand({id:"commit-and-push",name:"Commit and push",callback:async()=>{await this.runCommit("manual")&&await this.doPush()}}),this.addCommand({id:"pull-now",name:"Pull now",callback:()=>{this.doPull()}}),this.addCommand({id:"push-now",name:"Push now",callback:()=>{this.doPush()}}),this.setupVaultListeners(),this.setupFileContextMenu(),this.app.workspace.onLayoutReady(()=>{this.initStatusBadges(),this.settings.autoPullOnOpen&&!d.Platform.isMobileApp&&this.doPull()}),d.Platform.isMobileApp||(this.beforeUnloadHandler=()=>{if(this.settings.commitOnClose){let t=this.getVaultPathSafe();if(t){let i=ot(t,this.settings.gitPath);if(i.length>0){let n=new Date,r=q(this.settings.commitTemplate,{date:n.toISOString().slice(0,10),time:n.toTimeString().slice(0,8),files:i.slice(0,5).join(", ")+(i.length>5?"...":""),count:String(i.length)});if(this.settings.includeFileList){let a=i.length<=5?i.join(`
`):i.slice(0,5).join(`
`)+`
... and ${i.length-5} more`;r+=`

`+a}at(t,this.settings.gitPath,r)}}}},window.addEventListener("beforeunload",this.beforeUnloadHandler)),this.checkConflicts()}onunload(){var t;this.clearDebounce(),this.removeVaultListeners(),(t=this.statusBadges)==null||t.stop(),this.statusBadges=null,this.ribbonIconEl&&(this.ribbonIconEl.remove(),this.ribbonIconEl=null),this.beforeUnloadHandler&&(window.removeEventListener("beforeunload",this.beforeUnloadHandler),this.beforeUnloadHandler=null)}async loadSettings(){this.settings=Object.assign({},H,await this.loadData()),P(this.settings.debugLog)}async saveSettings(){await this.saveData(this.settings)}resetVaultListeners(){this.clearDebounce(),this.removeVaultListeners(),this.setupVaultListeners()}removeVaultListeners(){this.vaultEventRefs.forEach(t=>this.app.vault.offref(t)),this.vaultEventRefs=[]}setupVaultListeners(){if(d.Platform.isMobileApp){new d.Notice(g().noticeMobileNotSupported);return}this.vaultEventRefs.push(this.app.vault.on("create",t=>this.onFileChange(t,"create"))),this.vaultEventRefs.push(this.app.vault.on("modify",t=>this.onFileChange(t,"modify"))),this.vaultEventRefs.push(this.app.vault.on("delete",t=>this.onFileChange(t,"delete"))),this.vaultEventRefs.push(this.app.vault.on("rename",(t,i)=>this.onFileRename(t,i)))}onFileChange(t,i){t instanceof d.TFile&&(this.shouldIgnore(t.path)||(this.statusBadges&&(i==="create"?this.statusBadges.noteCreate(t.path):i==="modify"?this.statusBadges.noteModify(t.path):i==="delete"&&this.statusBadges.noteDelete(t.path)),this.settings.autoCommit&&this.scheduleCommit()))}onFileRename(t,i){var n;t instanceof d.TFile&&(this.shouldIgnore(i)&&this.shouldIgnore(t.path)||((n=this.statusBadges)==null||n.noteRename(i,t.path),this.settings.autoCommit&&this.scheduleCommit()))}shouldIgnore(t){if(t.startsWith(".git/")||t.startsWith(".git\\"))return!0;if(this.settings.ignoreObsidianDir){let i=this.app.vault.configDir;if(t.startsWith(i+"/")||t.startsWith(i+"\\"))return!0}return!1}scheduleCommit(){this.clearDebounce(),this.debounceTimer=window.setTimeout(()=>{this.debounceTimer=null,this.runCommit("auto")},this.settings.debounceSeconds*1e3)}clearDebounce(){this.debounceTimer!==null&&(window.clearTimeout(this.debounceTimer),this.debounceTimer=null)}getVaultPath(){let t=this.app.vault.adapter;if(!(t instanceof d.FileSystemAdapter))throw new Error(g().noticeDesktopOnly);return t.getBasePath()}getVaultPathSafe(){let t=this.app.vault.adapter;return t instanceof d.FileSystemAdapter?t.getBasePath():null}async runCommit(t){var n;if(this._hasConflicts)return t==="manual"&&new d.Notice(g().noticeCannotCommitConflict),!1;if(this.isCommitting)return this.pendingRerun=!0,!1;this.isCommitting=!0,this.pendingRerun=!1;let i=!1;try{let o=this.getVaultPath(),r=this.settings.gitPath,a=await x(o,r);if(a.length===0)return t==="manual"&&new d.Notice(g().noticeNoChanges),!1;let m=new f(g().noticeCommitting),c=new Date,h=q(this.settings.commitTemplate,{date:c.toISOString().slice(0,10),time:c.toTimeString().slice(0,8),files:a.slice(0,5).join(", ")+(a.length>5?"...":""),count:String(a.length)}),j=h;if(this.settings.includeFileList){let v=a.length<=5?a.join(`
`):a.slice(0,5).join(`
`)+`
... and ${a.length-5} more`;j=h+`

`+v}try{await Z(o,r,j),i=!0,m.succeed(g().noticeCommitted(a.length))}catch(v){throw m.fail(g().noticeAutoGitError(v.message)),v}t==="auto"&&this.settings.autoPush&&await this.doPush(),(n=this.statusBadges)==null||n.refresh()}catch(o){}finally{this.isCommitting=!1,this.pendingRerun&&this.scheduleCommit()}return i}async doPush(){let t=new f(g().noticePushing);try{let i=this.getVaultPath();await K(i,this.settings.gitPath),t.succeed(g().noticePushed)}catch(i){t.fail(g().noticePushFailed(i.message))}}updateRibbonButton(){this.settings.showRibbonButton&&!d.Platform.isMobileApp?this.ribbonIconEl||(this.ribbonIconEl=this.addRibbonIcon("git-branch","Git",t=>{this.showRibbonMenu(t)})):this.ribbonIconEl&&(this.ribbonIconEl.remove(),this.ribbonIconEl=null)}showRibbonMenu(t){let i=g(),n=new d.Menu;n.addItem(o=>o.setTitle(i.ribbonMenuPull).setIcon("download").onClick(()=>void this.doPull())),n.addItem(o=>o.setTitle(i.ribbonMenuCommit).setIcon("check").onClick(()=>void this.runCommit("manual"))),n.addItem(o=>o.setTitle(i.ribbonMenuPush).setIcon("upload").onClick(()=>void this.doPush())),n.addItem(o=>o.setTitle(i.ribbonMenuCommitAndPush).setIcon("upload").onClick(async()=>{await this.runCommit("manual")&&await this.doPush()})),n.addSeparator(),n.addItem(o=>o.setTitle(i.ribbonMenuRevertAll).setIcon("rotate-ccw").onClick(()=>void this.doRevert())),n.showAtMouseEvent(t)}async doRevert(){try{let t=this.getVaultPath(),i=await x(t,this.settings.gitPath);if(i.length===0){new d.Notice(g().revertNoChanges);return}new C(this.app,i,()=>{(async()=>{var n;try{await Y(t,this.settings.gitPath),new d.Notice(g().noticeReverted),(n=this.statusBadges)==null||n.refresh()}catch(o){new d.Notice(g().noticeRevertFailed(o.message))}})()}).open()}catch(t){new d.Notice(g().noticeRevertFailed(t.message))}}setupFileContextMenu(){d.Platform.isMobileApp||this.registerEvent(this.app.workspace.on("file-menu",(t,i)=>{var r;if(!(i instanceof d.TFile))return;let n=i.path;(r=this.statusBadges)!=null&&r.getStatus(n)&&t.addItem(a=>{a.setTitle(g().revertFileMenu).setIcon("rotate-ccw").onClick(()=>{new C(this.app,[n],()=>{(async()=>{var m;try{let c=this.getVaultPath();await tt(c,this.settings.gitPath,n),new d.Notice(g().noticeFileReverted),(m=this.statusBadges)==null||m.refresh()}catch(c){new d.Notice(g().noticeFileRevertFailed(c.message))}})()}).open()})})}))}async doPull(){var i;if(d.Platform.isMobileApp){new d.Notice(g().noticeMobileNotSupported);return}let t=new f(g().noticePulling);try{let n=this.getVaultPath(),o=await Q(n,this.settings.gitPath);o.hasConflicts?(await this.checkConflicts(),t.fail(g().noticeConflictDetected)):o.success&&(t.succeed(g().noticePulled),(i=this.statusBadges)==null||i.refresh())}catch(n){t.fail(g().noticePullFailed(n.message))}}async checkConflicts(){var n;let t=this.getVaultPathSafe();if(!t)return;let i=await z(t,this.settings.gitPath);this.conflictFiles=new Set(i),this.setHasConflicts(i.length>0),(n=this.statusBadges)==null||n.setConflicts(this.conflictFiles)}setHasConflicts(t){var i;this._hasConflicts=t,t&&!this.resolveConflictCommand&&(this.resolveConflictCommand=this.addCommand({id:"resolve-conflicts",name:"Mark conflicts as resolved",callback:async()=>{var o,r;let n=this.getVaultPathSafe();if(n)try{await N(n,this.settings.gitPath),this.conflictFiles.clear(),this.setHasConflicts(!1),(o=this.statusBadges)==null||o.setConflicts(this.conflictFiles),new d.Notice(g().noticeConflictResolved),(r=this.statusBadges)==null||r.refresh()}catch(a){new d.Notice(a.message)}}})),t||(this.conflictFiles.clear(),(i=this.statusBadges)==null||i.setConflicts(this.conflictFiles))}initStatusBadges(){d.Platform.isMobileApp||(this.statusBadges=new A({getCwd:()=>this.getVaultPathSafe(),getGitPath:()=>this.settings.gitPath,shouldIgnore:t=>this.shouldIgnore(t)}),this.statusBadges.setConflicts(this.conflictFiles),this.statusBadges.start(this.settings.showStatusBadge,this.settings.badgeRefreshInterval))}updateStatusBadges(){var t;if(d.Platform.isMobileApp){(t=this.statusBadges)==null||t.stop();return}if(!this.statusBadges){this.initStatusBadges();return}this.statusBadges.setConflicts(this.conflictFiles),this.statusBadges.start(this.settings.showStatusBadge,this.settings.badgeRefreshInterval)}refreshStatusBadges(){var t;(t=this.statusBadges)==null||t.refresh()}};
