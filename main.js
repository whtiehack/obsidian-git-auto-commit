var f=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var F=(s,i)=>{for(var t in i)f(s,t,{get:i[t],enumerable:!0})},E=(s,i,t,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let e of S(i))!A.call(s,e)&&e!==t&&f(s,e,{get:()=>i[e],enumerable:!(n=y(i,e))||n.enumerable});return s};var G=s=>E(f({},"__esModule",{value:!0}),s);var x={};F(x,{default:()=>p});module.exports=G(x);var a=require("obsidian");var l=require("obsidian");var L={settingsTitle:"Auto Git Commit",sectionAutomation:"Automation",sectionConfiguration:"Configuration",autoCommitName:"Enable auto commit",autoCommitDesc:"Automatically commit when files change (debounced).",debounceName:"Debounce delay (seconds)",debounceDesc:"Wait time after last change before committing.",autoPushName:"Auto push after commit",autoPushDesc:"Push to remote after successful commit.",templateName:"Commit message template",templateDesc:"Variables: {{date}}, {{time}}, {{files}}, {{count}}",gitPathName:"Git binary path",gitPathDesc:"Path to git executable. Default: git",ignoreObsidianName:"Ignore .obsidian directory",ignoreObsidianDesc:"Exclude config folder from triggering auto-commits.",includeFileListName:"Include file list in commit body",includeFileListDesc:"List changed files in commit message body, one per line.",noticeNoChanges:"No changes to commit.",noticeCommitted:s=>`Committed ${s} file(s).`,noticePushed:"Pushed to remote.",noticeAutoGitError:s=>`Auto Git error: ${s}`,noticePushFailed:s=>`Push failed: ${s}`,noticeMobileNotSupported:"Auto Git: Git not available on mobile.",noticeDesktopOnly:"Auto Git requires desktop vault."},b={settingsTitle:"\u81EA\u52A8 Git \u63D0\u4EA4",sectionAutomation:"\u81EA\u52A8\u5316",sectionConfiguration:"\u914D\u7F6E",autoCommitName:"\u542F\u7528\u81EA\u52A8\u63D0\u4EA4",autoCommitDesc:"\u6587\u4EF6\u53D8\u52A8\u540E\u81EA\u52A8\u63D0\u4EA4\uFF08\u9632\u6296\uFF09\u3002",debounceName:"\u9632\u6296\u5EF6\u8FDF\uFF08\u79D2\uFF09",debounceDesc:"\u6700\u540E\u4E00\u6B21\u53D8\u52A8\u540E\u7B49\u5F85\u591A\u4E45\u518D\u63D0\u4EA4\u3002",autoPushName:"\u63D0\u4EA4\u540E\u81EA\u52A8\u63A8\u9001",autoPushDesc:"\u63D0\u4EA4\u6210\u529F\u540E\u81EA\u52A8\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",templateName:"\u63D0\u4EA4\u6D88\u606F\u6A21\u677F",templateDesc:"\u53D8\u91CF: {{date}}, {{time}}, {{files}}, {{count}}",gitPathName:"Git \u53EF\u6267\u884C\u6587\u4EF6\u8DEF\u5F84",gitPathDesc:"git \u7684\u8DEF\u5F84\uFF0C\u9ED8\u8BA4: git",ignoreObsidianName:"\u5FFD\u7565 .obsidian \u76EE\u5F55",ignoreObsidianDesc:"\u6392\u9664\u914D\u7F6E\u6587\u4EF6\u5939\u89E6\u53D1\u81EA\u52A8\u63D0\u4EA4\u3002",includeFileListName:"\u5728\u63D0\u4EA4\u6B63\u6587\u4E2D\u5305\u542B\u6587\u4EF6\u5217\u8868",includeFileListDesc:"\u5728\u63D0\u4EA4\u6D88\u606F\u6B63\u6587\u4E2D\u5217\u51FA\u53D8\u52A8\u7684\u6587\u4EF6\uFF0C\u6BCF\u884C\u4E00\u4E2A\u3002",noticeNoChanges:"\u6CA1\u6709\u53EF\u63D0\u4EA4\u7684\u66F4\u6539\u3002",noticeCommitted:s=>`\u5DF2\u63D0\u4EA4 ${s} \u4E2A\u6587\u4EF6\u3002`,noticePushed:"\u5DF2\u63A8\u9001\u5230\u8FDC\u7A0B\u4ED3\u5E93\u3002",noticeAutoGitError:s=>`\u81EA\u52A8 Git \u9519\u8BEF: ${s}`,noticePushFailed:s=>`\u63A8\u9001\u5931\u8D25: ${s}`,noticeMobileNotSupported:"\u81EA\u52A8 Git: \u79FB\u52A8\u7AEF\u4E0D\u652F\u6301 Git\u3002",noticeDesktopOnly:"\u81EA\u52A8 Git \u9700\u8981\u684C\u9762\u7AEF\u3002"},C={en:L,zh:b,"zh-CN":b,"zh-TW":b};function O(){return window.localStorage.getItem("language")||"en"}function u(){let s=O();return C[s]||C.en}var P={autoCommit:!1,debounceSeconds:30,commitTemplate:"vault backup: {{date}} {{time}}",includeFileList:!1,autoPush:!1,gitPath:"git",ignoreObsidianDir:!0},h=class extends l.PluginSettingTab{constructor(i,t){super(i,t),this.plugin=t}display(){let{containerEl:i}=this,t=u();i.empty(),i.createEl("h2",{text:t.settingsTitle}),i.createEl("h3",{text:t.sectionAutomation}),new l.Setting(i).setName(t.autoCommitName).setDesc(t.autoCommitDesc).addToggle(n=>n.setValue(this.plugin.settings.autoCommit).onChange(async e=>{this.plugin.settings.autoCommit=e,await this.plugin.saveSettings(),this.plugin.resetVaultListeners(),this.display()})),this.plugin.settings.autoCommit&&(new l.Setting(i).setName(t.debounceName).setDesc(t.debounceDesc).addText(n=>n.setPlaceholder("30").setValue(String(this.plugin.settings.debounceSeconds)).onChange(async e=>{let o=parseInt(e);!isNaN(o)&&o>=5&&(this.plugin.settings.debounceSeconds=o,await this.plugin.saveSettings())})),new l.Setting(i).setName(t.autoPushName).setDesc(t.autoPushDesc).addToggle(n=>n.setValue(this.plugin.settings.autoPush).onChange(async e=>{this.plugin.settings.autoPush=e,await this.plugin.saveSettings()}))),i.createEl("h3",{text:t.sectionConfiguration}),new l.Setting(i).setName(t.templateName).setDesc(t.templateDesc).addTextArea(n=>n.setPlaceholder("vault backup: {{date}} {{time}}").setValue(this.plugin.settings.commitTemplate).onChange(async e=>{this.plugin.settings.commitTemplate=e,await this.plugin.saveSettings()})),new l.Setting(i).setName(t.includeFileListName).setDesc(t.includeFileListDesc).addToggle(n=>n.setValue(this.plugin.settings.includeFileList).onChange(async e=>{this.plugin.settings.includeFileList=e,await this.plugin.saveSettings()})),new l.Setting(i).setName(t.gitPathName).setDesc(t.gitPathDesc).addText(n=>n.setPlaceholder("git").setValue(this.plugin.settings.gitPath).onChange(async e=>{this.plugin.settings.gitPath=e.trim()||"git",await this.plugin.saveSettings()})),new l.Setting(i).setName(t.ignoreObsidianName).setDesc(t.ignoreObsidianDesc).addToggle(n=>n.setValue(this.plugin.settings.ignoreObsidianDir).onChange(async e=>{this.plugin.settings.ignoreObsidianDir=e,await this.plugin.saveSettings()}))}};var v=require("child_process");function d({cwd:s,gitPath:i,args:t}){return new Promise((n,e)=>{(0,v.execFile)(i,t,{cwd:s,windowsHide:!0,env:{...process.env,GIT_TERMINAL_PROMPT:"0"}},(o,r,c)=>{if(o){e(new Error((c==null?void 0:c.trim())||o.message));return}n(r)})})}async function w(s,i){let t=await d({cwd:s,gitPath:i,args:["status","--porcelain=v1","-z"]});if(!t)return[];let n=t.split("\0").filter(Boolean),e=[];for(let o=0;o<n.length;o++){let r=n[o],c=r.slice(0,2),m=r.slice(3);if(m&&e.push(m),c.startsWith("R")||c.startsWith("C")){let g=n[++o];g&&e.push(g)}}return[...new Set(e)]}async function D(s,i,t){await d({cwd:s,gitPath:i,args:["add","-A"]});try{await d({cwd:s,gitPath:i,args:["commit","-m",t]})}catch(n){let e=n.message;if(e.includes("nothing to commit")||e.includes("no changes added"))return;throw n}}async function N(s,i){await d({cwd:s,gitPath:i,args:["push"]})}function T(s,i){return s.replace(/\{\{\s*([a-zA-Z0-9_]+)\s*\}\}/g,(t,n)=>{var e;return(e=i[n])!=null?e:""})}var p=class extends a.Plugin{constructor(){super(...arguments);this.settings=P;this.debounceTimer=null;this.isCommitting=!1;this.pendingRerun=!1;this.vaultEventRefs=[]}async onload(){await this.loadSettings(),this.addSettingTab(new h(this.app,this)),this.addCommand({id:"commit-now",name:"Commit now",callback:()=>this.runCommit("manual")}),this.addCommand({id:"commit-and-push",name:"Commit and push",callback:async()=>{await this.runCommit("manual")&&await this.doPush()}}),this.setupVaultListeners()}onunload(){this.clearDebounce(),this.removeVaultListeners()}async loadSettings(){this.settings=Object.assign({},P,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}resetVaultListeners(){this.clearDebounce(),this.removeVaultListeners(),this.setupVaultListeners()}removeVaultListeners(){this.vaultEventRefs.forEach(t=>this.app.vault.offref(t)),this.vaultEventRefs=[]}setupVaultListeners(){if(!this.settings.autoCommit)return;if(a.Platform.isMobileApp){new a.Notice(u().noticeMobileNotSupported);return}let t=n=>this.onFileChange(n);this.vaultEventRefs.push(this.app.vault.on("create",t)),this.vaultEventRefs.push(this.app.vault.on("modify",t)),this.vaultEventRefs.push(this.app.vault.on("delete",t)),this.vaultEventRefs.push(this.app.vault.on("rename",t))}onFileChange(t){t instanceof a.TFile&&(this.shouldIgnore(t.path)||this.scheduleCommit())}shouldIgnore(t){return!!(t.startsWith(".git/")||t.startsWith(".git\\")||this.settings.ignoreObsidianDir&&(t.startsWith(".obsidian/")||t.startsWith(".obsidian\\")))}scheduleCommit(){this.clearDebounce(),this.debounceTimer=window.setTimeout(()=>{this.debounceTimer=null,this.runCommit("auto")},this.settings.debounceSeconds*1e3)}clearDebounce(){this.debounceTimer!==null&&(window.clearTimeout(this.debounceTimer),this.debounceTimer=null)}getVaultPath(){let t=this.app.vault.adapter;if(!(t instanceof a.FileSystemAdapter))throw new Error(u().noticeDesktopOnly);return t.getBasePath()}async runCommit(t){if(this.isCommitting)return this.pendingRerun=!0,!1;this.isCommitting=!0,this.pendingRerun=!1;let n=!1;try{let e=this.getVaultPath(),o=this.settings.gitPath,r=await w(e,o);if(r.length===0)return t==="manual"&&new a.Notice(u().noticeNoChanges),!1;let c=new Date,m=T(this.settings.commitTemplate,{date:c.toISOString().slice(0,10),time:c.toTimeString().slice(0,8),files:r.slice(0,5).join(", ")+(r.length>5?"...":""),count:String(r.length)}),g=m;this.settings.includeFileList&&(g=m+`

`+r.join(`
`)),await D(e,o,g),n=!0,new a.Notice(u().noticeCommitted(r.length)),this.settings.autoPush&&await this.doPush()}catch(e){new a.Notice(u().noticeAutoGitError(e.message))}finally{this.isCommitting=!1,this.pendingRerun&&this.scheduleCommit()}return n}async doPush(){try{let t=this.getVaultPath();await N(t,this.settings.gitPath),new a.Notice(u().noticePushed)}catch(t){new a.Notice(u().noticePushFailed(t.message))}}};
